<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Database</title>
    <style>
        /* General Styles */
        :root {
            --bg-color-day: #f4f4f4;
            --container-bg-day: #ffffff;
            --text-color-day: #333;
            --heading-color-day: #0056b3;
            --border-color-day: #eee;
            --input-border-day: #ccc;
            --input-focus-border-day: #007bff;
            --input-focus-shadow-day: rgba(0, 123, 255, 0.5);
            --placeholder-bg-day: #e9ecef;
            --placeholder-border-day: #ced4da;
            --placeholder-text-day: #6c757d;
            --qa-bg-day: #f9f9f9;
            --qa-border-day: #ddd;

            --bg-color-night: #121212; /* Darker BG */
            --container-bg-night: #1e1e1e; /* Slightly lighter container */
            --text-color-night: #e0e0e0;
            --heading-color-night: #FCB130; /* Accent for headings */
            --border-color-night: #444;
            --input-border-night: #555;
            --input-focus-border-night: #FCB130; /* Accent */
            --input-focus-shadow-night: rgba(252, 177, 48, 0.5);
            --placeholder-bg-night: #2a2a2a;
            --placeholder-border-night: #555;
            --placeholder-text-night: #888;
            --qa-bg-night: #252525;
            --qa-border-night: #444;

            /* Theme Colors */
            --primary-bg: #1D4886; /* User specified background */
            --accent-color: #FCB130; /* User specified accent */
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            width: 100%;
            min-height: 100vh; /* Ensure body takes full height */
            background-color: var(--primary-bg); /* Use primary BG for body */
            color: var(--text-color-day);
            transition: background-color 0.3s, color 0.3s;
        }

        body.night-mode {
            background-color: var(--primary-bg); /* Keep primary BG */
            color: var(--text-color-night);
        }

        .header-controls {
            position: fixed; /* Keep toggle visible */
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .container {
            width: 90%;
            max-width: 850px; /* Slightly wider */
            background-color: var(--container-bg-day);
            color: var(--text-color-day); /* Text color inside container */
            padding: 25px;
            margin-top: 60px; /* Add space for fixed header controls */
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: background-color 0.3s, color 0.3s;
        }

        body.night-mode .container {
            background-color: var(--container-bg-night);
            color: var(--text-color-night);
        }

        /* View Sections */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2, h3 {
            color: var(--heading-color-day);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color-day);
            padding-bottom: 10px;
            margin-bottom: 20px;
            transition: color 0.3s, border-color 0.3s;
        }
        body.night-mode h2, body.night-mode h3 {
            color: var(--heading-color-night);
            border-bottom-color: var(--border-color-night);
        }

        /* Buttons */
        .button {
            padding: 10px 20px; /* Adjusted padding */
            font-size: 15px; /* Adjusted font size */
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-right: 10px;
            margin-top: 5px; /* Add some top margin */
            margin-bottom: 5px; /* Add some bottom margin */
            background-color: var(--accent-color); /* Accent color for buttons */
            color: #fff; /* White text on accent */
            font-weight: bold;
        }
        .button:hover {
            opacity: 0.85;
        }
        body.night-mode .button {
             /* Keep accent color in night mode maybe? Or adjust if needed */
             background-color: var(--accent-color);
             color: #333; /* Darker text on accent for night mode contrast */
        }
        .button-secondary { /* For less prominent actions like 'Add Question' */
            background-color: #6c757d;
            color: white;
        }
        body.night-mode .button-secondary {
             background-color: #5a6268;
        }
        .button-back { /* Consistent back button style */
             background-color: #6c757d;
             color: white;
        }
        body.night-mode .button-back {
             background-color: #5a6268;
        }
         .button-delete { /* Style for delete Q&A button */
             background-color: #dc3545; /* Red */
             color: white;
             padding: 3px 8px;
             font-size: 12px;
             margin-left: 10px;
             vertical-align: middle;
         }
          body.night-mode .button-delete {
              background-color: #c82333;
          }
         button:disabled {
             background-color: #adb5bd;
             cursor: not-allowed;
             opacity: 0.7;
         }
         body.night-mode button:disabled {
              background-color: #5a6268;
         }


        /* Menu Styles */
        .menu-buttons button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 16px;
            /* Use accent color */
            /* background-color: var(--accent-color); */
            /* color: white; */
            /* border: none; */
            /* border-radius: 5px; */
            /* cursor: pointer; */
            /* transition: background-color 0.3s ease; */
        }
        /* .menu-buttons button:hover {
            background-color: #e09a2a; /* Darker accent */
        /* } */
        /* body.night-mode .menu-buttons button:hover {
             background-color: #d49020;
        } */


        /* Form Styles */
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-color-day); }
        body.night-mode .form-section label { color: var(--text-color-night); }

        .form-section input[type="text"],
        .form-section select,
        .form-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border-day);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            margin-bottom: 10px;
            background-color: var(--container-bg-day);
            color: var(--text-color-day);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        body.night-mode .form-section input[type="text"],
        body.night-mode .form-section select,
        body.night-mode .form-section textarea {
             background-color: #333; /* Darker input field */
             color: var(--text-color-night);
             border-color: var(--input-border-night);
        }

        .form-section input[type="text"]:focus,
        .form-section select:focus,
        .form-section textarea:focus {
             border-color: var(--input-focus-border-day);
             outline: none;
             box-shadow: 0 0 5px var(--input-focus-shadow-day);
        }
         body.night-mode .form-section input[type="text"]:focus,
         body.night-mode .form-section select:focus,
         body.night-mode .form-section textarea:focus {
             border-color: var(--input-focus-border-night);
             box-shadow: 0 0 5px var(--input-focus-shadow-night);
         }

        .form-section textarea { min-height: 100px; resize: vertical; }

        /* Specific field styling */
        #add-captain-field { display: none; margin-top: -5px; margin-bottom: 10px; }
        #add-captain-field input { margin-bottom: 0; }
        .captain-select-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .captain-select-container select { flex-grow: 1; margin-bottom: 0; }
        /* Removed button style from here */

        /* Q&A Section */
        .qa-pair {
            background-color: var(--qa-bg-day);
            border: 1px dashed var(--qa-border-day);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative; /* For positioning delete button */
            transition: background-color 0.3s, border-color 0.3s;
        }
         body.night-mode .qa-pair {
             background-color: var(--qa-bg-night);
             border-color: var(--qa-border-night);
         }
        .qa-pair label { font-weight: bold; color: var(--text-color-day); }
         body.night-mode .qa-pair label { color: var(--text-color-night); }
        .qa-pair input[type="text"] { margin-bottom: 10px; }
        .qa-pair input[type="text"]:last-child { margin-bottom: 0; }
        .qa-pair .button-delete { /* Position delete button */
             position: absolute;
             top: 5px;
             right: 5px;
         }


        /* Radio Button Styling */
        .radio-group { margin-bottom: 20px; }
        .radio-group label { display: inline-block; margin-right: 20px; font-weight: normal; cursor: pointer; }
        .radio-group input[type="radio"] { margin-right: 5px; vertical-align: middle; }

        /* Placeholder / List Styling */
        .placeholder-content, .data-list, .profile-display {
            padding: 20px;
            background-color: var(--placeholder-bg-day);
            border: 1px solid var(--placeholder-border-day);
            border-radius: 5px;
            color: var(--placeholder-text-day);
            margin-top: 15px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        body.night-mode .placeholder-content,
        body.night-mode .data-list,
        body.night-mode .profile-display {
             background-color: var(--placeholder-bg-night);
             border-color: var(--placeholder-border-night);
             color: var(--text-color-night); /* Use main text color */
        }
         .data-list ul {
             list-style: none;
             padding: 0;
             margin: 0;
         }
         .data-list li {
             padding: 10px;
             border-bottom: 1px solid var(--border-color-day);
             transition: border-color 0.3s;
         }
         body.night-mode .data-list li {
              border-bottom-color: var(--border-color-night);
         }
         .data-list li:last-child {
             border-bottom: none;
         }
         .captain-name {
             font-weight: bold;
             font-size: 1.1em;
             color: var(--heading-color-day);
         }
         body.night-mode .captain-name {
              color: var(--heading-color-night);
         }
         .captain-details {
             font-size: 0.9em;
             color: #555;
             margin-left: 5px;
         }
          body.night-mode .captain-details {
               color: #bbb;
          }
          .profile-section {
             margin-bottom: 15px;
             padding-bottom: 15px;
             border-bottom: 1px dashed var(--border-color-day);
          }
           body.night-mode .profile-section {
               border-bottom-color: var(--border-color-night);
           }
           .profile-section:last-child {
               border-bottom: none;
               margin-bottom: 0;
               padding-bottom: 0;
           }
           .profile-section h4 {
               margin-top: 0;
               margin-bottom: 8px;
               color: var(--heading-color-day);
           }
            body.night-mode .profile-section h4 {
                color: var(--heading-color-night);
            }
           .profile-section pre { /* Preserve whitespace in details */
               white-space: pre-wrap;
               word-wrap: break-word;
               background-color: rgba(0,0,0,0.03); /* Slight background */
               padding: 8px;
               border-radius: 4px;
               font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; /* Monospace for details */
               font-size: 0.95em;
           }
            body.night-mode .profile-section pre {
                 background-color: rgba(255,255,255,0.05);
                 color: #eee; /* Lighter text */
            }
            .profile-section .qa-item {
                margin-bottom: 8px;
                font-size: 0.95em;
            }
             .profile-section .qa-item strong { /* Style Question */
                 display: block;
                 margin-bottom: 2px;
                 color: #333;
             }
              body.night-mode .profile-section .qa-item strong {
                   color: #ddd;
              }

        /* Search View Specific */
        #search-dropdown-container label { margin-bottom: 10px; }
        #search-captain-select { width: 100%; padding: 10px; font-size: 15px; margin-bottom: 20px; }
         body.night-mode #search-captain-select {
              background-color: #333;
              color: var(--text-color-night);
              border-color: var(--input-border-night);
         }


        /* Toggle Switch Styles (from flightcard) */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px; /* Slightly larger */
          height: 24px; /* Slightly larger */
          vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 24px; /* Fully rounded */
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 18px; /* Adjusted handle */
          width: 18px; /* Adjusted handle */
          left: 3px; /* Adjusted position */
          bottom: 3px; /* Adjusted position */
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--accent-color); /* Use accent color */
        }
        input:focus + .slider {
          box-shadow: 0 0 1px var(--accent-color);
        }
        input:checked + .slider:before {
          transform: translateX(26px); /* Adjusted distance */
        }

    </style>
</head>
<body>

    <div class="header-controls">
        <label class="switch" title="Toggle Day/Night Mode">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
        </label>
    </div>

    <div class="container">

        <div id="menu-view" class="view active">
            <h2>Captain Database Menu</h2>
            <div class="menu-buttons">
                <button class="button" onclick="showView('submit-view')">Submit New Entry</button>
                <button class="button" onclick="showView('good-guys-view')">View Good Guys</button>
                <button class="button" onclick="showView('bad-guys-view')">View Bad Guys</button>
                <button class="button" onclick="showView('search-view')">Search Captains</button>
                <button class="button" onclick="showView('abba-view')">ABBA Q&A Compilation</button>
            </div>
             <button class="button button-secondary" onclick="refreshData()" style="margin-top: 20px;">Refresh Data from Sheet</button>
        </div>

        <div id="submit-view" class="view">
            <h2>Submit New Entry</h2>
            <form id="entry-form">
                <div class="form-section">
                    <label for="captain-name-select">Captain Name</label>
                    <div class="captain-select-container">
                         <select id="captain-name-select" name="captainNameSelect">
                             <option value="" selected disabled>-- Select Existing or Add New --</option>
                             <option value="__add_new__">-- Add New Captain --</option>
                         </select>
                    </div>
                    <div id="add-captain-field">
                         <label for="captain-name-new">New Captain Name:</label>
                         <input type="text" id="captain-name-new" name="captainNameNew">
                    </div>
                </div>

                <div class="form-section">
                    <label for="appointment">Appointment (Your observation)</label>
                    <select id="appointment" name="appointment">
                        <option value="" selected disabled>-- Select Appointment --</option>
                        <option value="Line">Line</option>
                        <option value="SUC">SUC</option>
                        <option value="LIP">LIP</option>
                        <option value="MGMT">MGMT</option>
                    </select>
                </div>

                <div class="form-section">
                    <label for="experience">Experience / Remarks</label>
                    <textarea id="experience" name="experience" placeholder="Share your overall experience, notable events, or general remarks..."></textarea>
                </div>

                <div class="form-section">
                    <label for="dos">Do's</label>
                    <textarea id="dos" name="dos" placeholder="What behaviours, techniques, or preferences are encouraged?"></textarea>
                </div>

                <div class="form-section">
                    <label for="donts">Don'ts</label>
                    <textarea id="donts" name="donts" placeholder="What behaviours, actions, or topics should be avoided?"></textarea>
                </div>

                <div class="form-section">
                    <h3>Captain Specific Q&A</h3>
                    <div id="qa-container">
                        </div>
                    <button type="button" class="button button-secondary" onclick="addQaPair()">Add Question</button>
                </div>

                <div class="form-section radio-group">
                     <label>Rate This Interaction:</label>
                     <label for="good-guy">
                         <input type="radio" id="good-guy" name="rating" value="good"> Good Guy
                     </label>
                     <label for="bad-guy">
                         <input type="radio" id="bad-guy" name="rating" value="bad"> Bad Guy
                     </label>
                 </div>


                <div class="form-section">
                    <button type="submit" class="button button-primary">Submit Entry</button>
                    <button type="button" class="button button-back" onclick="showView('menu-view')">Back to Menu</button>
                </div>
            </form>
        </div>

        <div id="good-guys-view" class="view">
             <h2>Good Guys List</h2>
             <div id="good-guys-list-content" class="data-list">
                 <div class="placeholder-content">Loading data...</div>
             </div>
             <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="bad-guys-view" class="view">
             <h2>Bad Guys List</h2>
             <div id="bad-guys-list-content" class="data-list">
                  <div class="placeholder-content">Loading data...</div>
             </div>
             <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="search-view" class="view">
            <h2>Search Captains</h2>
            <div id="search-dropdown-container" class="form-section">
                 <label for="search-captain-select">Select Captain to View Profile:</label>
                 <select id="search-captain-select">
                     <option value="" selected disabled>-- Select Captain --</option>
                     </select>
            </div>
             <div id="search-profile-content" class="profile-display" style="display: none;">
                  </div>
             <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>


        <div id="abba-view" class="view">
            <h2>ABBA Q&A Compilation</h2>
             <div id="abba-list-content" class="data-list">
                  <div class="placeholder-content">Loading data...</div>
             </div>
              <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

    </div> <script>
        // --- Credentials (REPLACE WITH YOUR ACTUAL VALUES!) ---
        // !!! IMPORTANT: Replace with your NEW, PRIVATE API key after deleting the old one !!!
        const API_KEY = 'AIzaSyA0JGGJAYg_xY8EpR-cVn4hVFKkZyji5ck';
        const SPREADSHEET_ID = '1JNwm0Tl2HpaDW6MJdrF_0bcTL7imtwvYldt1UDx1r3Q'; // Replace with your Sheet ID
        // !!! REPLACE THIS WITH THE WEB APP URL YOU COPIED !!!
        const WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE';

        // --- Global Cache for Sheet Data ---
        let allSheetData = null; // To store fetched data
        let captainProfiles = {}; // To store processed data grouped by captain
        let isFetching = false; // Prevent multiple simultaneous fetches

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle');

        function setDarkMode(isNight) {
            if (isNight) {
                document.body.classList.add('night-mode');
                localStorage.setItem('darkModePref', 'true');
                if(darkModeToggle) darkModeToggle.checked = true;
            } else {
                document.body.classList.remove('night-mode');
                localStorage.setItem('darkModePref', 'false');
                if(darkModeToggle) darkModeToggle.checked = false;
            }
        }

        if (darkModeToggle) {
             darkModeToggle.addEventListener('change', () => {
                setDarkMode(darkModeToggle.checked);
            });
        }
         // --- End Night Mode ---

        // --- Utility Functions ---
        function findMode(arr) {
            if (!arr || arr.length === 0) return 'N/A';
            return arr.sort((a,b) =>
                  arr.filter(v => v===a).length
                - arr.filter(v => v===b).length
            ).pop();
        }

        // --- Data Fetching & Processing ---

        // Fetches ALL data from the sheet
        async function fetchAllData() {
             if (isFetching) {
                 console.log("Fetch already in progress...");
                 return false; // Indicate fetch wasn't started now
             }
             if (!API_KEY || API_KEY === 'YOUR_NEW_PRIVATE_API_KEY' || !SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID') {
                console.warn("API Key or Spreadsheet ID is not set correctly.");
                alert("Configuration incomplete. Please set your NEW API Key and Spreadsheet ID in the script.");
                return false;
             }
             console.log("Fetching all data from sheet...");
             isFetching = true;

            // Define the range to fetch all relevant columns (A to I - Timestamp to SubmissionID)
            // Adjust 'Sheet1' if your sheet name is different
            // Fetching from row 2 downwards to skip headers
             const range = 'Sheet1!A2:I';
             const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}&valueRenderOption=UNFORMATTED_VALUE&dateTimeRenderOption=SERIAL_NUMBER`;

            try {
                const response = await fetch(apiUrl);
                const responseData = await response.json();

                if (!response.ok) {
                    console.error('Error response from API:', responseData);
                    const error = responseData.error || {};
                    const status = error.status || response.status;
                    const message = error.message || response.statusText;
                    alert(`Error fetching data: ${status} - ${message}`);
                    throw new Error(`HTTP error! status: ${status}`);
                }

                console.log("All data fetched successfully.");
                allSheetData = responseData.values || []; // Store fetched data [[row], [row], ...]
                processAllData(); // Process the data immediately after fetching
                return true; // Indicate successful fetch

            } catch (error) {
                console.error('Could not fetch all data:', error);
                alert(`Failed to fetch data from sheet: ${error.message}`);
                allSheetData = null; // Reset cache on error
                captainProfiles = {};
                return false; // Indicate fetch failed
            } finally {
                 isFetching = false; // Allow fetching again
            }
        }

        // Processes the raw sheet data into a structured format
        function processAllData() {
            if (!allSheetData) return;
            console.log("Processing fetched data...");
            captainProfiles = {}; // Reset processed data

            // Assuming columns A-I map to:
            // 0:Timestamp, 1:Name, 2:Appointment, 3:Experience, 4:Dos, 5:Donts, 6:Questions (JSON), 7:Rating, 8:SubmissionID
            allSheetData.forEach(row => {
                const name = row[1];
                if (!name || name.trim() === '') return; // Skip if no captain name

                if (!captainProfiles[name]) {
                    captainProfiles[name] = {
                        name: name,
                        submissions: [],
                        appointments: [],
                        ratings: [],
                        goodCount: 0,
                        badCount: 0,
                        aggregate: { // Store calculated aggregate data
                            appointment: 'N/A',
                            status: 'Neutral', // Good, Bad, Neutral
                        }
                    };
                }

                const submission = {
                    timestamp: row[0] ? new Date(Math.round((row[0] - 25569) * 86400 * 1000)) : null, // Convert Sheets date number to JS Date
                    appointment: row[2] || '',
                    experience: row[3] || '',
                    dos: row[4] || '',
                    donts: row[5] || '',
                    questions: [],
                    rating: row[7] || '',
                    id: row[8] || ''
                };

                // Safely parse questions JSON
                try {
                     if(row[6]) {
                         submission.questions = JSON.parse(row[6]);
                         if (!Array.isArray(submission.questions)) submission.questions = [];
                     }
                } catch(e) {
                     console.warn(`Could not parse questions JSON for ${name}, submission ID ${submission.id}: ${row[6]}`);
                     submission.questions = []; // Default to empty array on parse error
                }


                captainProfiles[name].submissions.push(submission);
                if (submission.appointment) captainProfiles[name].appointments.push(submission.appointment);
                if (submission.rating === 'good') captainProfiles[name].goodCount++;
                if (submission.rating === 'bad') captainProfiles[name].badCount++;
                if (submission.rating) captainProfiles[name].ratings.push(submission.rating);
            });

            // Calculate aggregate status and appointment for each captain
            Object.values(captainProfiles).forEach(profile => {
                if (profile.goodCount > profile.badCount) {
                    profile.aggregate.status = 'Good';
                } else if (profile.badCount > profile.goodCount) {
                    profile.aggregate.status = 'Bad';
                } else {
                    profile.aggregate.status = 'Neutral'; // Or 'Even'
                }
                profile.aggregate.appointment = findMode(profile.appointments) || 'N/A';
            });

            console.log("Data processed:", captainProfiles);
             // Update dropdowns that depend on captain names
             populateSubmitDropdown();
             populateSearchDropdown();
        }

        // Populates the dropdown in the Submit form
        function populateSubmitDropdown() {
             const selectElement = document.getElementById('captain-name-select');
             if (!selectElement) return;

             // Get current selection to potentially restore it
             const currentSelection = selectElement.value;

             // Clear existing options (except the placeholder and "Add New")
             while (selectElement.options.length > 2) {
                 selectElement.remove(1); // Remove the second option repeatedly
             }

             const names = Object.keys(captainProfiles).sort();
             const addNewOption = selectElement.options[selectElement.options.length - 1];
             names.forEach(name => {
                 const option = document.createElement('option');
                 option.value = name;
                 option.textContent = name;
                 selectElement.insertBefore(option, addNewOption);
             });
              // Try to restore selection
              if (names.includes(currentSelection)) {
                  selectElement.value = currentSelection;
              } else {
                   selectElement.value = ""; // Reset to placeholder if previous selection gone
              }
         }

         // Populates the dropdown in the Search view
         function populateSearchDropdown() {
              const selectElement = document.getElementById('search-captain-select');
              if (!selectElement) return;

              // Clear existing options (except the placeholder)
              while (selectElement.options.length > 1) {
                  selectElement.remove(1);
              }

              const names = Object.keys(captainProfiles).sort();
              names.forEach(name => {
                  const option = document.createElement('option');
                  option.value = name;
                  option.textContent = name;
                  selectElement.appendChild(option);
              });
          }

         // --- Display Logic for Views ---

         function displayList(type) { // type is 'good' or 'bad'
            const targetDivId = type === 'good' ? 'good-guys-list-content' : 'bad-guys-list-content';
            const listDiv = document.getElementById(targetDivId);
            if (!listDiv) return;

            if (!allSheetData) { // Data not loaded yet
                listDiv.innerHTML = '<div class="placeholder-content">Data not loaded. Try Refreshing.</div>';
                return;
            }
             if (Object.keys(captainProfiles).length === 0) {
                 listDiv.innerHTML = '<div class="placeholder-content">No captain data processed.</div>';
                 return;
             }

            const statusFilter = type === 'good' ? 'Good' : 'Bad';
            const filteredCaptains = Object.values(captainProfiles).filter(p => p.aggregate.status === statusFilter);

            if (filteredCaptains.length === 0) {
                listDiv.innerHTML = `<div class="placeholder-content">No captains currently classified as '${statusFilter}'.</div>`;
                return;
            }

            let html = '<ul>';
            filteredCaptains.sort((a, b) => a.name.localeCompare(b.name)).forEach(profile => {
                html += `<li>
                            <span class="captain-name">${profile.name}</span>
                            <span class="captain-details">(Appointment: ${profile.aggregate.appointment})</span>
                         </li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
         }

         function displayAbba() {
             const listDiv = document.getElementById('abba-list-content');
             if (!listDiv) return;

             if (!allSheetData) {
                 listDiv.innerHTML = '<div class="placeholder-content">Data not loaded. Try Refreshing.</div>';
                 return;
             }

             let allQuestions = [];
             Object.values(captainProfiles).forEach(profile => {
                 profile.submissions.forEach(sub => {
                      if (sub.questions && Array.isArray(sub.questions)) {
                          sub.questions.forEach(qa => {
                               if (qa.q && qa.q.trim() !== '') { // Only include if question exists
                                   allQuestions.push({ captain: profile.name, q: qa.q.trim(), a: (qa.a || '').trim() });
                               }
                          });
                      }
                 });
             });

             if (allQuestions.length === 0) {
                  listDiv.innerHTML = '<div class="placeholder-content">No questions submitted yet.</div>';
                  return;
             }

             // Simple display, could group by question later if needed
             let html = '<ul>';
             allQuestions.sort((a,b) => a.q.localeCompare(b.q) || a.captain.localeCompare(b.captain)).forEach(item => {
                  html += `<li>
                              <strong>Q: ${item.q}</strong> (For ${item.captain}) <br>
                              A: ${item.a || '<i>No answer provided</i>'}
                           </li>`;
             });
             html += '</ul>';
             listDiv.innerHTML = html;

         }

          function displayCaptainProfile(captainName) {
              const profileDiv = document.getElementById('search-profile-content');
              const profile = captainProfiles[captainName];

              if (!profileDiv || !profile) {
                  if(profileDiv) profileDiv.innerHTML = '<div class="placeholder-content">Select a captain from the dropdown.</div>';
                  return;
              }

              profileDiv.style.display = 'block'; // Show the profile area

              let html = `<h3>Profile: ${profile.name}</h3>`;
              html += `<p><strong>Calculated Status:</strong> ${profile.aggregate.status} (Good: ${profile.goodCount}, Bad: ${profile.badCount})</p>`;
              html += `<p><strong>Most Common Appointment:</strong> ${profile.aggregate.appointment}</p>`;
              html += `<hr>`;

              if (profile.submissions.length > 0) {
                   html += `<h4>Individual Submissions (${profile.submissions.length}):</h4>`;
                   // Sort submissions by timestamp, newest first
                   profile.submissions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                   profile.submissions.forEach((sub, index) => {
                        html += `<div class="profile-section">`;
                        html += `<h5>Submission ${profile.submissions.length - index} (${sub.timestamp ? sub.timestamp.toLocaleDateString() : 'N/A'}) - Rating: ${sub.rating || 'N/A'}, Appt: ${sub.appointment || 'N/A'}</h5>`;

                        if(sub.experience) html += `<h4>Experience/Remarks:</h4><pre>${escapeHtml(sub.experience)}</pre>`;
                        if(sub.dos) html += `<h4>Do's:</h4><pre>${escapeHtml(sub.dos)}</pre>`;
                        if(sub.donts) html += `<h4>Don'ts:</h4><pre>${escapeHtml(sub.donts)}</pre>`;

                        if (sub.questions && sub.questions.length > 0) {
                             html += `<h4>Q&A:</h4>`;
                             sub.questions.forEach(qa => {
                                  if (qa.q) { // Only display if question exists
                                      html += `<div class="qa-item"><strong>Q: ${escapeHtml(qa.q)}</strong> A: ${escapeHtml(qa.a || 'N/A')}</div>`;
                                  }
                             });
                        }
                        html += `</div>`; // close profile-section
                   });
              } else {
                   html += `<p>No detailed submissions found.</p>`;
              }

              profileDiv.innerHTML = html;
          }

         // Helper to escape HTML special characters for display in <pre> or similar
         function escapeHtml(unsafe) {
             if (!unsafe) return '';
             return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
         }


         // --- View Switching ---
        async function showView(viewId) { // Make async
            console.log('showView called with ID:', viewId);

             // Fetch or use cached data if needed for the view
             if (['good-guys-view', 'bad-guys-view', 'search-view', 'abba-view'].includes(viewId)) {
                 if (!allSheetData && !isFetching) {
                     // If data isn't loaded and not currently fetching, start fetch
                     const fetchSuccess = await fetchAllData();
                     if (!fetchSuccess) {
                         // Optionally show an error in the target view if fetch failed
                          const targetDiv = document.getElementById(viewId)?.querySelector('.data-list, .profile-display, #search-dropdown-container');
                          if (targetDiv) targetDiv.innerHTML = '<div class="placeholder-content" style="color: red;">Failed to load data. Please try Refreshing.</div>';
                          // Maybe prevent switching view on fetch failure? Or allow but show error.
                     }
                 } else if (isFetching) {
                      // Optionally show a generic loading message if fetch is in progress
                      const targetDiv = document.getElementById(viewId)?.querySelector('.data-list, .profile-display, #search-dropdown-container');
                      if (targetDiv) targetDiv.innerHTML = '<div class="placeholder-content">Loading data...</div>';
                 }
                 // If data is loaded (allSheetData exists), proceed to display logic
             }

             // Populate content based on viewId AFTER potentially fetching/processing data
              if (viewId === 'good-guys-view') {
                   displayList('good');
              } else if (viewId === 'bad-guys-view') {
                   displayList('bad');
              } else if (viewId === 'abba-view') {
                   displayAbba();
              } else if (viewId === 'search-view') {
                   // Dropdown is populated when data is processed
                   // Clear previous profile display
                    const profileDiv = document.getElementById('search-profile-content');
                    if(profileDiv) {
                         profileDiv.style.display = 'none';
                         profileDiv.innerHTML = '';
                    }
                    const searchSelect = document.getElementById('search-captain-select');
                    if (searchSelect) searchSelect.value = ""; // Reset dropdown selection
              } else if (viewId === 'submit-view') {
                   // Ensure submit dropdown is up-to-date (uses processed data)
                   populateSubmitDropdown();
              }


            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            // Show the selected view
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
            }

            // Form reset logic (keep as is or refine)
             if (viewId !== 'submit-view') {
                 const qaContainer = document.getElementById('qa-container');
                 if(qaContainer) qaContainer.innerHTML = '';
                 qaCounter = 0;

                 const addCaptainField = document.getElementById('add-captain-field');
                 if(addCaptainField) addCaptainField.style.display = 'none';

                 // Don't reset submit dropdown value here, only on explicit back/submit action
                 // const captainSelect = document.getElementById('captain-name-select');
                 // if(captainSelect) captainSelect.value = '';

                 const entryForm = document.getElementById('entry-form');
                 if(entryForm) entryForm.reset();
             }
        }

         // --- Handle Captain Selection (Submit Form) ---
        const captainSelect = document.getElementById('captain-name-select');
        const newCaptainField = document.getElementById('add-captain-field');
        const newCaptainInput = document.getElementById('captain-name-new');

        if (captainSelect) {
            captainSelect.addEventListener('change', function() {
                if (this.value === '__add_new__') {
                    if(newCaptainField) newCaptainField.style.display = 'block';
                    if(newCaptainInput) { newCaptainInput.required = true; newCaptainInput.focus(); }
                } else {
                    if(newCaptainField) newCaptainField.style.display = 'none';
                    if(newCaptainInput) { newCaptainInput.required = false; newCaptainInput.value = ''; }
                }
            });
        } else { console.error("Captain select dropdown not found!"); }

         // --- Handle Captain Selection (Search View) ---
         const searchCaptainSelect = document.getElementById('search-captain-select');
         if (searchCaptainSelect) {
              searchCaptainSelect.addEventListener('change', function() {
                   if (this.value) {
                        displayCaptainProfile(this.value);
                   } else {
                        // Clear profile if placeholder selected
                         const profileDiv = document.getElementById('search-profile-content');
                         if(profileDiv) {
                              profileDiv.style.display = 'none';
                              profileDiv.innerHTML = '';
                         }
                   }
              });
         } else { console.error("Search captain select dropdown not found!"); }


        // --- Dynamic Q&A Pairs ---
        let qaCounter = 0;
        function addQaPair() {
            qaCounter++;
            const qaContainer = document.getElementById('qa-container');
            if (!qaContainer) { console.error("Q&A container not found!"); return; }

            const newPair = document.createElement('div');
            newPair.classList.add('qa-pair');
            newPair.id = `qa-pair-${qaCounter}`; // Add ID for deletion
            newPair.innerHTML = `
                <button type="button" class="button button-delete" onclick="deleteQaPair(${qaCounter})">X</button>
                <label for="question-${qaCounter}">Q${qaCounter}:</label>
                <input type="text" id="question-${qaCounter}" name="question_${qaCounter}" placeholder="Enter question...">
                <label for="answer-${qaCounter}">A${qaCounter}:</label>
                <input type="text" id="answer-${qaCounter}" name="answer_${qaCounter}" placeholder="Enter answer...">
            `;
            qaContainer.appendChild(newPair);
        }

         function deleteQaPair(pairId) {
             const pairElement = document.getElementById(`qa-pair-${pairId}`);
             if (pairElement) {
                 pairElement.remove();
                 // Note: This doesn't reset the qaCounter, so IDs remain unique
                 // Form submission logic needs to handle potentially missing IDs if pairs are deleted.
                 // The current submission logic iterates from 1 to qaCounter, so it might try to get
                 // data from deleted pairs. Let's adjust submission logic.
             }
         }


        // --- Form Submission ---
        const entryForm = document.getElementById('entry-form');
        if (entryForm) {
             // !!! REPLACE THIS WITH THE WEB APP URL YOU COPIED !!!
             const WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE';

            entryForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const submitButton = entryForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                // Gather form data
                const formData = new FormData(entryForm);
                const data = {
                    // Initialize fields to prevent 'undefined' issues if optional fields are empty
                    timestamp: new Date().toISOString(), // Add timestamp from client side
                    captainName: '',
                    appointment: formData.get('appointment') || '',
                    experience: formData.get('experience') || '',
                    dos: formData.get('dos') || '',
                    donts: formData.get('donts') || '',
                    rating: formData.get('rating') || '',
                    questions: '' // Will be JSON string
                };
                const questions = [];

                 // Determine Captain Name
                 const selectedName = formData.get('captainNameSelect');
                 const newName = formData.get('captainNameNew')?.trim();
                 if (selectedName === '__add_new__') {
                     if (!newName) {
                          alert("Please enter the new Captain's Name.");
                          submitButton.disabled = false; submitButton.textContent = originalButtonText; return;
                     }
                      data.captainName = newName;
                 } else if (selectedName) {
                      data.captainName = selectedName;
                 } else {
                      alert("Please select or add a Captain Name.");
                      submitButton.disabled = false; submitButton.textContent = originalButtonText; return;
                 }


                // Consolidate ACTIVE Q&A pairs (check if div exists)
                const qaPairs = document.querySelectorAll('#qa-container .qa-pair');
                qaPairs.forEach(pairDiv => {
                    const qInput = pairDiv.querySelector('input[name^="question_"]');
                    const aInput = pairDiv.querySelector('input[name^="answer_"]');
                    if (qInput && aInput) { // Ensure inputs are found
                         const q = qInput.value.trim();
                         const a = aInput.value.trim();
                         if (q || a) { // Only add if at least one field has content
                            questions.push({ q: q || '', a: a || '' });
                         }
                    }
                });
                data.questions = JSON.stringify(questions);

                console.log("Collected Form Data for POST:", data);

                // --- Send Data to Google Apps Script Web App ---
                try {
                    if (!WEB_APP_URL || WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
                         throw new Error("Web App URL is not set in the script.");
                     }

                    const urlEncodedData = new URLSearchParams(data);

                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                        body: urlEncodedData
                    });

                     const result = await response.json();
                     console.log("Response from Web App:", result);

                     if (result.status === 'success') {
                        alert("Entry submitted successfully!");
                        // --- Trigger data refresh after successful submission ---
                        allSheetData = null; // Invalidate cache
                        captainProfiles = {};
                        await fetchAllData(); // Refetch and reprocess
                        // ---------------------------------------------------------
                        entryForm.reset();
                        const qaContainer = document.getElementById('qa-container');
                        if(qaContainer) qaContainer.innerHTML = '';
                        qaCounter = 0;
                        if(newCaptainField) newCaptainField.style.display = 'none';
                        showView('menu-view');
                     } else {
                         throw new Error(result.message || "Unknown error from Apps Script.");
                     }

                } catch (error) {
                    console.error("Error submitting data:", error);
                    alert(`Submission failed: ${error.message}`);
                } finally {
                     submitButton.disabled = false;
                     submitButton.textContent = originalButtonText;
                }
            });
        } else { console.error("Entry form not found!"); }

         // --- Refresh Data Manually ---
         async function refreshData() {
             console.log("Manual refresh requested.");
             allSheetData = null; // Invalidate cache
             captainProfiles = {};
             alert("Refreshing data from Google Sheet...");
             const fetchSuccess = await fetchAllData();
             if(fetchSuccess) {
                 alert("Data refreshed successfully!");
                 // Re-render current view if it depends on data
                 const currentView = document.querySelector('.view.active');
                 if (currentView) {
                      showView(currentView.id); // Re-call showView to re-render content
                 }
             } else {
                  alert("Failed to refresh data.");
             }
         }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
             console.log("DOM fully loaded and parsed");

             // Set initial dark mode state based on localStorage
              const savedDarkMode = localStorage.getItem('darkModePref');
              setDarkMode(savedDarkMode === 'true');

             // Fetch initial data
             await fetchAllData(); // Fetch and process data on load

             // Initial view
             showView('menu-view');
        });

    </script>

</body>
</html>
