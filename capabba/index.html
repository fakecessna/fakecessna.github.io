<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Database</title>
    <style>
        /* General Styles */
        :root {
            --bg-color-day: #f4f4f4; --container-bg-day: #ffffff; --text-color-day: #333; --heading-color-day: #0056b3;
            --border-color-day: #eee; --input-border-day: #ccc; --input-focus-border-day: #007bff; --input-focus-shadow-day: rgba(0, 123, 255, 0.5);
            --placeholder-bg-day: #e9ecef; --placeholder-border-day: #ced4da; --placeholder-text-day: #6c757d; --qa-bg-day: #f9f9f9;
            --qa-border-day: #ddd; --link-color-day: #0056b3;

            --bg-color-night: #121212; --container-bg-night: #1e1e1e; --text-color-night: #e0e0e0; --heading-color-night: #FCB130;
            --border-color-night: #444; --input-border-night: #555; --input-focus-border-night: #FCB130; --input-focus-shadow-night: rgba(252, 177, 48, 0.5);
            --placeholder-bg-night: #2a2a2a; --placeholder-border-night: #555; --placeholder-text-night: #888; --qa-bg-night: #252525;
            --qa-border-night: #444; --link-color-night: #ffcc66;

            /* Theme Colors */
            --primary-bg: #1D4886; --accent-color: #FCB130; --button-text-day: #fff; --button-text-night: #e0e0e0; --button-bg-night: #5a6268;
        }
        html, body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; box-sizing: border-box; width: 100%; min-height: 100vh; background-color: var(--primary-bg); color: var(--text-color-day); transition: background-color 0.3s, color 0.3s; }
        body.night-mode { background-color: var(--primary-bg); color: var(--text-color-night); }
        .header-controls { position: fixed; top: 10px; right: 10px; z-index: 100; }
        .container { width: 90%; max-width: 850px; background-color: var(--container-bg-day); color: var(--text-color-day); padding: 25px; margin-top: 60px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: background-color 0.3s, color 0.3s; display: none; }
        body.night-mode .container { background-color: var(--container-bg-night); color: var(--text-color-night); }
        body.unlocked .container { display: block; }
        .view { display: none; animation: fadeIn 0.5s ease-in-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2, h3 { color: var(--heading-color-day); margin-top: 0; border-bottom: 1px solid var(--border-color-day); padding-bottom: 10px; margin-bottom: 20px; transition: color 0.3s, border-color 0.3s; }
        body.night-mode h2, body.night-mode h3 { color: var(--heading-color-night); border-bottom-color: var(--border-color-night); }
        .button { padding: 10px 20px; font-size: 15px; cursor: pointer; border: none; border-radius: 5px; transition: background-color 0.3s ease, color 0.3s ease; margin-right: 10px; margin-top: 5px; margin-bottom: 5px; background-color: var(--accent-color); color: var(--button-text-day); font-weight: bold; }
        .button:hover { opacity: 0.85; }
        body.night-mode .button { background-color: var(--button-bg-night); color: var(--button-text-night); }
        .button-secondary { background-color: #6c757d; color: white; }
        body.night-mode .button-secondary { background-color: #5a6268; color: var(--button-text-night); }
        .button-back { background-color: #6c757d; color: white; }
        body.night-mode .button-back { background-color: #5a6268; color: var(--button-text-night); }
        .button-delete { background-color: #dc3545; color: white; padding: 3px 8px; font-size: 12px; margin-left: 10px; vertical-align: middle; }
        body.night-mode .button-delete { background-color: #c82333; color: white;}
        button:disabled { background-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
        body.night-mode button:disabled { background-color: #5a6268; }
        .menu-buttons button { display: block; width: 100%; padding: 15px; margin-bottom: 10px; font-size: 16px; }
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-color-day); }
        body.night-mode .form-section label { color: var(--text-color-night); }
        .form-section input[type="text"], .form-section select, .form-section textarea { width: 100%; padding: 10px; border: 1px solid var(--input-border-day); border-radius: 4px; box-sizing: border-box; font-size: 14px; margin-bottom: 10px; background-color: var(--container-bg-day); color: var(--text-color-day); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body.night-mode .form-section input[type="text"], body.night-mode .form-section select, body.night-mode .form-section textarea { background-color: #333; color: var(--text-color-night); border-color: var(--input-border-night); }
        .form-section input[type="text"]:focus, .form-section select:focus, .form-section textarea:focus { border-color: var(--input-focus-border-day); outline: none; box-shadow: 0 0 5px var(--input-focus-shadow-day); }
        body.night-mode .form-section input[type="text"]:focus, body.night-mode .form-section select:focus, body.night-mode .form-section textarea:focus { border-color: var(--input-focus-border-night); box-shadow: 0 0 5px var(--input-focus-shadow-night); }
        .form-section textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        #add-captain-field { display: none; margin-top: -5px; margin-bottom: 10px; }
        #add-captain-field input { margin-bottom: 0; }
        .captain-select-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .captain-select-container select { flex-grow: 1; margin-bottom: 0; }
        .qa-pair { background-color: var(--qa-bg-day); border: 1px dashed var(--qa-border-day); padding: 15px; margin-bottom: 15px; border-radius: 4px; position: relative; transition: background-color 0.3s, border-color 0.3s; }
        body.night-mode .qa-pair { background-color: var(--qa-bg-night); border-color: var(--qa-border-night); }
        .qa-pair label { font-weight: bold; color: var(--text-color-day); }
        body.night-mode .qa-pair label { color: var(--text-color-night); }
        .qa-pair textarea { width: 100%; padding: 8px; border: 1px solid var(--input-border-day); border-radius: 4px; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; background-color: var(--container-bg-day); color: var(--text-color-day); transition: background-color 0.3s, color 0.3s, border-color 0.3s; min-height: 50px; resize: vertical; font-family: inherit;}
        body.night-mode .qa-pair textarea { background-color: #333; color: var(--text-color-night); border-color: var(--input-border-night); }
        .qa-pair textarea:last-child { margin-bottom: 0; }
        .qa-pair .button-delete { position: absolute; top: 5px; right: 5px; }
        .radio-group { margin-bottom: 20px; }
        .radio-group label { display: inline-block; margin-right: 20px; font-weight: normal; cursor: pointer; }
        .radio-group input[type="radio"] { margin-right: 5px; vertical-align: middle; }
        .placeholder-content, .data-list, .profile-display { padding: 20px; background-color: var(--placeholder-bg-day); border: 1px solid var(--placeholder-border-day); border-radius: 5px; color: var(--placeholder-text-day); margin-top: 15px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body.night-mode .placeholder-content, body.night-mode .data-list, body.night-mode .profile-display { background-color: var(--placeholder-bg-night); border-color: var(--placeholder-border-night); color: var(--text-color-night); }
        .data-list ul { list-style: none; padding: 0; margin: 0; }
        .data-list li { padding: 10px; border-bottom: 1px solid var(--border-color-day); transition: border-color 0.3s; }
        body.night-mode .data-list li { border-bottom-color: var(--border-color-night); }
        .data-list li:last-child { border-bottom: none; }
        .captain-name { font-weight: bold; font-size: 1.1em; color: var(--link-color-day); cursor: pointer; text-decoration: underline; }
        .captain-name:hover { opacity: 0.8; }
        body.night-mode .captain-name { color: var(--link-color-night); }
        .captain-details { font-size: 0.9em; color: #555; margin-left: 5px; }
        body.night-mode .captain-details { color: #bbb; }
        .profile-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color-day); }
        body.night-mode .profile-section { border-bottom-color: var(--border-color-night); }
        .profile-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .profile-section h4 { margin-top: 0; margin-bottom: 8px; color: var(--heading-color-day); }
        body.night-mode .profile-section h4 { color: var(--heading-color-night); }
        .profile-section pre { white-space: pre-wrap; word-wrap: break-word; background-color: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.95em; max-height: 250px; overflow-y: auto; }
        body.night-mode .profile-section pre { background-color: rgba(255,255,255,0.05); color: #eee; }
        .profile-section .qa-item { margin-bottom: 8px; font-size: 0.95em; }
        .profile-section .qa-item strong { display: block; margin-bottom: 2px; color: #333; }
        body.night-mode .profile-section .qa-item strong { color: #ddd; }
        #search-container label { margin-bottom: 10px; }
        #search-box { width: 100%; padding: 10px; font-size: 15px; margin-bottom: 10px; }
        body.night-mode #search-box { background-color: #333; color: var(--text-color-night); border-color: var(--input-border-night); }
        #search-results-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color-day); border-radius: 4px; margin-bottom: 20px; }
        body.night-mode #search-results-list { border-color: var(--border-color-night); }
        #search-results-list div { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid var(--border-color-day); }
        #search-results-list div:last-child { border-bottom: none; }
        #search-results-list div:hover { background-color: #eee; }
        body.night-mode #search-results-list div:hover { background-color: #333; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>

    <div class="header-controls">
        <label class="switch" title="Toggle Day/Night Mode">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
        </label>
    </div>

    <div class="container"> <div id="menu-view" class="view active">
             <h2>Captain Database</h2>
             <div class="menu-buttons">
                 <button class="button" onclick="showView('submit-view')">Submit New Entry</button>
                 <button class="button" onclick="showView('good-guys-view')">View Good Guys</button>
                 <button class="button" onclick="showView('bad-guys-view')">View Bad Guys</button>
                 <button class="button" onclick="showView('search-view')">Search Captains</button>
                 <button class="button" onclick="showView('abba-view')">ABBA Q&A Compilation</button>
             </div>
        </div>

        <div id="submit-view" class="view">
             <h2>Submit New Entry</h2>
             <form id="entry-form">
                 <div class="form-section"> <label for="captain-name-select">Captain Name</label> <div class="captain-select-container"> <select id="captain-name-select" name="captainNameSelect" required> <option value="" selected disabled>-- Select Existing or Add New --</option> <option value="__add_new__">-- Add New Captain --</option> </select> </div> <div id="add-captain-field"> <label for="captain-name-new">New Captain Name:</label> <input type="text" id="captain-name-new" name="captainNameNew"> </div> </div>
                 <div class="form-section"> <label for="appointment">Appointment</label> <select id="appointment" name="appointment" required> <option value="" selected disabled>-- Select Appointment --</option> <option value="Line">Line</option> <option value="SUC">SUC</option> <option value="LIP">LIP</option> <option value="MGMT">MGMT</option> </select> </div>
                 <div class="form-section"> <label for="experience">Experience / Remarks</label> <textarea id="experience" name="experience" placeholder="Share your overall experience, notable events, or general remarks..."></textarea> </div>
                 <div class="form-section"> <label for="dos">Do's</label> <textarea id="dos" name="dos" placeholder="What behaviours, techniques, or preferences are encouraged?"></textarea> </div>
                 <div class="form-section"> <label for="donts">Don'ts</label> <textarea id="donts" name="donts" placeholder="What behaviours, actions, or topics should be avoided?"></textarea> </div>
                 <div class="form-section"> <h3>Captain Specific Q&A</h3> <div id="qa-container"></div> <button type="button" class="button button-secondary" onclick="addQaPair()">Add Question</button> </div>
                 <div class="form-section radio-group"> <label>Rate This Interaction:</label> <label for="good-guy"><input type="radio" id="good-guy" name="rating" value="good" required> Good Guy</label> <label for="bad-guy"><input type="radio" id="bad-guy" name="rating" value="bad"> Bad Guy</label> </div>
                 <div class="form-section"> <button type="submit" class="button button-primary">Submit Entry</button> <button type="button" class="button button-back" onclick="showView('menu-view')">Back to Menu</button> </div>
             </form>
        </div>

        <div id="good-guys-view" class="view">
              <h2>Good Guys List</h2>
              <div id="good-guys-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div>
              <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="bad-guys-view" class="view">
              <h2>Bad Guys List</h2>
              <div id="bad-guys-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div>
              <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="search-view" class="view">
             <h2>Search Captains</h2>
             <div id="search-container" class="form-section">
                 <label for="search-box">Search by Captain Name:</label>
                 <input type="text" id="search-box" placeholder="Start typing a name...">
                 <div id="search-results-list" class="data-list" style="display: none;"> </div>
             </div>
              <div id="search-profile-content" class="profile-display" style="display: none;"></div>
              <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="abba-view" class="view">
             <h2>ABBA Q&A Compilation</h2>
             <div id="abba-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div>
             <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="profile-view" class="view">
              <h2 id="profile-view-captain-name">Captain Profile</h2>
              <div id="profile-view-content" class="profile-display"><div class="placeholder-content">Loading profile...</div></div>
              <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

    </div> <script>
        // --- Credentials & Password Location ---
        const API_KEY = 'AIzaSyA0JGGJAYg_xY8EpR-cVn4hVFKkZyji5ck'; // Replace
        const SPREADSHEET_ID = '1JNwm0Tl2HpaDW6MJdrF_0bcTL7imtwvYldt1UDx1r3Q'; // Replace
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS42fKFx8_A2XL1Aa1nOAOpeelyz1w02T_nl1zF-cGXR1CwOvJSYaCiy06IKWTzBDPWA/exec'; // Replace
        const PASSWORD_SHEET_NAME = 'Sheet2';
        const PASSWORD_CELL = 'A1';

        // --- Global Cache & State ---
        let allSheetData = null;
        let captainProfiles = {};
        let isFetching = false;
        let lastView = 'menu-view';
        let isAuthenticated = false;

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        function setDarkMode(isNight) {
             if (isNight) { document.body.classList.add('night-mode'); localStorage.setItem('darkModePref', 'true'); if(darkModeToggle) darkModeToggle.checked = true; }
             else { document.body.classList.remove('night-mode'); localStorage.setItem('darkModePref', 'false'); if(darkModeToggle) darkModeToggle.checked = false; }
         }
        if (darkModeToggle) { darkModeToggle.addEventListener('change', () => setDarkMode(darkModeToggle.checked)); }

        // --- Utility Functions ---
        function findMode(arr) {
            if (!arr || arr.length === 0) return 'N/A';
            return arr.sort((a,b) => arr.filter(v => v===a).length - arr.filter(v => v===b).length).pop();
        }
        function escapeHtml(unsafe) {
             if (!unsafe) return '';
             return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
         }

        // --- Data Fetching & Processing ---
        async function fetchAllData() {
            if (isFetching) { console.log("Fetch already in progress..."); return false; }
            if (!API_KEY || API_KEY === 'YOUR_NEW_PRIVATE_API_KEY' || !SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID') { console.warn("API Key or Spreadsheet ID is not set correctly."); alert("Configuration incomplete. Please set your NEW API Key and Spreadsheet ID in the script."); return false; }
            console.log("Fetching all data from sheet..."); isFetching = true; document.body.style.cursor = 'wait';
            const range = 'Sheet1!A2:I'; const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}&valueRenderOption=UNFORMATTED_VALUE&dateTimeRenderOption=SERIAL_NUMBER`;
            try {
                const response = await fetch(apiUrl); const responseData = await response.json();
                if (!response.ok) { console.error('Error response from API:', responseData); const error = responseData.error || {}; const status = error.status || response.status; const message = error.message || response.statusText; alert(`Error fetching data: ${status} - ${message}`); throw new Error(`HTTP error! status: ${status}`); }
                console.log("All data fetched successfully."); allSheetData = responseData.values || []; processAllData(); return true;
            } catch (error) { console.error('Could not fetch all data:', error); alert(`Failed to fetch data from sheet: ${error.message}. Check console (F12) and API Key/Sheet settings.`); allSheetData = null; captainProfiles = {}; populateSubmitDropdown(); /* Removed populateSearchDropdown */ displayList('good'); displayList('bad'); displayAbba(); return false;
            } finally { isFetching = false; document.body.style.cursor = 'default'; }
         }

        function processAllData() {
             if (!allSheetData) return; console.log("Processing fetched data..."); captainProfiles = {};
             allSheetData.forEach(row => { const name = row[1]; if (!name || name.trim() === '') return; if (!captainProfiles[name]) { captainProfiles[name] = { name: name, submissions: [], appointments: [], ratings: [], goodCount: 0, badCount: 0, aggregate: { appointment: 'N/A', status: 'Neutral' } }; } const submission = { timestamp: row[0] ? new Date(Math.round((row[0] - 25569) * 86400 * 1000)) : null, appointment: row[2] || '', experience: row[3] || '', dos: row[4] || '', donts: row[5] || '', questions: [], rating: row[7] || '', id: row[8] || '' }; try { if(row[6]) { submission.questions = JSON.parse(row[6]); if (!Array.isArray(submission.questions)) submission.questions = []; } } catch(e) { console.warn(`Could not parse questions JSON for ${name}, submission ID ${submission.id}: ${row[6]}`); submission.questions = []; } captainProfiles[name].submissions.push(submission); if (submission.appointment) captainProfiles[name].appointments.push(submission.appointment); if (submission.rating === 'good') captainProfiles[name].goodCount++; if (submission.rating === 'bad') captainProfiles[name].badCount++; if (submission.rating) captainProfiles[name].ratings.push(submission.rating); });
             Object.values(captainProfiles).forEach(profile => { if (profile.goodCount > profile.badCount) { profile.aggregate.status = 'Good'; } else if (profile.badCount > profile.goodCount) { profile.aggregate.status = 'Bad'; } else { profile.aggregate.status = 'Neutral'; } profile.aggregate.appointment = findMode(profile.appointments) || 'N/A'; });
             console.log("Data processed:", captainProfiles); populateSubmitDropdown(); /* Removed populateSearchDropdown */
        }

        function populateSubmitDropdown() {
            const selectElement = document.getElementById('captain-name-select'); if (!selectElement) return; const currentSelection = selectElement.value;
            // Clear existing (keep placeholder)
            while (selectElement.options.length > 1) { selectElement.remove(1); }
            // Add "Add New" first
            const addNewOption = document.createElement('option'); addNewOption.value = '__add_new__'; addNewOption.textContent = '-- Add New Captain --'; selectElement.appendChild(addNewOption);
            // Add sorted names
            const names = Object.keys(captainProfiles).sort(); names.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; selectElement.appendChild(option); });
            if (names.includes(currentSelection) || currentSelection === '__add_new__') { selectElement.value = currentSelection; } else { selectElement.value = ""; }
        }
        // Removed populateSearchDropdown

        // --- Display Logic for Views ---
        function displayList(type) {
            const targetDivId = type === 'good' ? 'good-guys-list-content' : 'bad-guys-list-content'; const listDiv = document.getElementById(targetDivId); if (!listDiv) return; if (!allSheetData) { listDiv.innerHTML = '<div class="placeholder-content">Data not loaded. Please check configuration or refresh.</div>'; return; } if (Object.keys(captainProfiles).length === 0 && allSheetData.length > 0) { listDiv.innerHTML = '<div class="placeholder-content">Processing data... Please wait.</div>'; return; } if (Object.keys(captainProfiles).length === 0 && allSheetData.length === 0) { listDiv.innerHTML = '<div class="placeholder-content">No data found in sheet.</div>'; return; } const statusFilter = type === 'good' ? 'Good' : 'Bad'; const filteredCaptains = Object.values(captainProfiles).filter(p => p.aggregate.status === statusFilter); if (filteredCaptains.length === 0) { listDiv.innerHTML = `<div class="placeholder-content">No captains currently classified as '${statusFilter}'.</div>`; return; } let html = '<ul>'; filteredCaptains.sort((a, b) => a.name.localeCompare(b.name)).forEach(profile => { html += `<li><span class="captain-name" onclick="showProfileView('${escapeHtml(profile.name)}')">${escapeHtml(profile.name)}</span> <span class="captain-details">(Appt: ${escapeHtml(profile.aggregate.appointment)})</span></li>`; }); html += '</ul>'; listDiv.innerHTML = html;
         }
        function displayAbba() {
              const listDiv = document.getElementById('abba-list-content'); if (!listDiv) return; if (!allSheetData) { listDiv.innerHTML = '<div class="placeholder-content">Data not loaded. Please check configuration or refresh.</div>'; return; } let allQuestions = []; Object.values(captainProfiles).forEach(profile => { profile.submissions.forEach(sub => { if (sub.questions && Array.isArray(sub.questions)) { sub.questions.forEach(qa => { if (qa.q && qa.q.trim() !== '') { allQuestions.push({ captain: profile.name, q: qa.q.trim(), a: (qa.a || '').trim() }); } }); } }); }); if (allQuestions.length === 0) { listDiv.innerHTML = '<div class="placeholder-content">No questions submitted yet.</div>'; return; } let html = '<ul>'; allQuestions.sort((a,b) => a.q.localeCompare(b.q) || a.captain.localeCompare(b.captain)).forEach(item => { html += `<li><strong>Q: ${escapeHtml(item.q)}</strong> (For ${escapeHtml(item.captain)}) <br> A: ${item.a ? escapeHtml(item.a) : '<i>No answer provided</i>'}</li>`; }); html += '</ul>'; listDiv.innerHTML = html;
         }
         // Modified displayCaptainProfile for compiled view
        function displayCaptainProfile(captainName, targetDivId = 'search-profile-content') {
              const profileDiv = document.getElementById(targetDivId); const profile = captainProfiles[captainName]; if (!profileDiv || !profile) { console.error(`Profile or target div not found for ${captainName} in #${targetDivId}`); if(profileDiv) profileDiv.innerHTML = `<div class="placeholder-content">Could not load profile for ${escapeHtml(captainName)}.</div>`; return; }
              if (targetDivId === 'profile-view-content') { const profileTitle = document.getElementById('profile-view-captain-name'); if (profileTitle) profileTitle.textContent = `Profile: ${profile.name}`; }
              profileDiv.style.display = 'block';
              let compiledExperience = []; let compiledDos = []; let compiledDonts = []; let compiledQuestions = [];
              profile.submissions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
              profile.submissions.forEach(sub => { if (sub.experience?.trim()) compiledExperience.push(sub.experience.trim()); if (sub.dos?.trim()) compiledDos.push(sub.dos.trim()); if (sub.donts?.trim()) compiledDonts.push(sub.donts.trim()); if (sub.questions && Array.isArray(sub.questions)) { sub.questions.forEach(qa => { if(qa.q?.trim()) { compiledQuestions.push({ q: qa.q.trim(), a: (qa.a || '').trim() }); } }); } });
              let html = `<p><strong>Calculated Status:</strong> ${profile.aggregate.status} (Good: ${profile.goodCount}, Bad: ${profile.badCount})</p><p><strong>Most Common Appointment:</strong> ${profile.aggregate.appointment}</p><hr>`;
              if (compiledExperience.length > 0) { html += `<div class="profile-section"><h4>Experience / Remarks (Compiled):</h4><pre>${escapeHtml(compiledExperience.join('\n\n---\n\n'))}</pre></div>`; } else { html += `<div class="profile-section"><h4>Experience / Remarks:</h4><p><i>No entries found.</i></p></div>`; }
              if (compiledDos.length > 0) { html += `<div class="profile-section"><h4>Do's (Compiled):</h4><pre>${escapeHtml(compiledDos.join('\n\n---\n\n'))}</pre></div>`; } else { html += `<div class="profile-section"><h4>Do's:</h4><p><i>No entries found.</i></p></div>`; }
              if (compiledDonts.length > 0) { html += `<div class="profile-section"><h4>Don'ts (Compiled):</h4><pre>${escapeHtml(compiledDonts.join('\n\n---\n\n'))}</pre></div>`; } else { html += `<div class="profile-section"><h4>Don'ts:</h4><p><i>No entries found.</i></p></div>`; }
              if (compiledQuestions.length > 0) { html += `<div class="profile-section"><h4>Q&A (Compiled):</h4>`; compiledQuestions.forEach(qa => { html += `<div class="qa-item"><strong>Q: ${escapeHtml(qa.q)}</strong><br>A: ${escapeHtml(qa.a || 'N/A')}</div>`; }); html += `</div>`; } else { html += `<div class="profile-section"><h4>Q&A:</h4><p><i>No entries found.</i></p></div>`; }
              profileDiv.innerHTML = html;
          }

        // --- View Switching & Control ---
        async function showView(viewId) {
            if (!isAuthenticated) { return; } const currentActive = document.querySelector('.view.active'); if(currentActive) previousView = currentActive.id; console.log(`Switching view to: ${viewId}, Previous: ${previousView}`); const dataViews = ['good-guys-view', 'bad-guys-view', 'search-view', 'abba-view', 'profile-view']; const requiresLoad = dataViews.includes(viewId) && viewId !== 'profile-view'; let targetContentArea = document.getElementById(viewId)?.querySelector('.data-list, .profile-display, #profile-view-content, #search-results-list');
            if (requiresLoad || (viewId === 'search-view')) { if (targetContentArea && viewId !== 'search-view' && viewId !== 'profile-view') { targetContentArea.innerHTML = '<div class="placeholder-content">Loading data...</div>'; } else if (viewId === 'search-view') { const searchBox = document.getElementById('search-box'); const resultsList = document.getElementById('search-results-list'); const profileDiv = document.getElementById('search-profile-content'); if (searchBox) searchBox.value = ''; if (resultsList) { resultsList.style.display = 'none'; resultsList.innerHTML = ''; } if (profileDiv) { profileDiv.style.display = 'none'; profileDiv.innerHTML = ''; } } }
            if (requiresLoad) { if (!allSheetData && !isFetching) { const fetchSuccess = await fetchAllData(); if (!fetchSuccess && targetContentArea) { targetContentArea.innerHTML = '<div class="placeholder-content" style="color: red;">Failed to load data.</div>'; } } else if (isFetching && targetContentArea) { /* Loading */ } }
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active')); if (allSheetData || !dataViews.includes(viewId) || viewId === 'search-view') { if (viewId === 'good-guys-view') { displayList('good'); } else if (viewId === 'bad-guys-view') { displayList('bad'); } else if (viewId === 'abba-view') { displayAbba(); } else if (viewId === 'search-view') { /* Search handled by input */ } else if (viewId === 'submit-view') { populateSubmitDropdown(); } } const activeView = document.getElementById(viewId); if (activeView) { activeView.classList.add('active'); } else { console.error(`View with ID ${viewId} not found!`); }
            if (previousView === 'submit-view' && viewId !== 'submit-view') { const qaContainer = document.getElementById('qa-container'); if(qaContainer) qaContainer.innerHTML = ''; qaCounter = 0; const addCaptainField = document.getElementById('add-captain-field'); if(addCaptainField) addCaptainField.style.display = 'none'; const entryForm = document.getElementById('entry-form'); if(entryForm) entryForm.reset(); }
         }
        function showProfileView(captainName) {
            if (!isAuthenticated) return; if (!captainName) return; console.log(`Showing profile for: ${captainName}`); if (!captainProfiles[captainName]) { alert("Captain data not found. Please refresh data."); return; } displayCaptainProfile(captainName, 'profile-view-content'); showView('profile-view');
         }

        // --- Handle Captain Selection (Submit Form) ---
        const captainSelect = document.getElementById('captain-name-select');
        const newCaptainField = document.getElementById('add-captain-field');
        const newCaptainInput = document.getElementById('captain-name-new');
        if (captainSelect && newCaptainField && newCaptainInput) { captainSelect.addEventListener('change', function() { console.log('Captain dropdown changed. Selected value:', this.value); if (this.value === '__add_new__') { console.log('Add New selected. Showing input field.'); newCaptainField.style.display = 'block'; newCaptainInput.required = true; newCaptainInput.focus(); } else { console.log('Existing captain selected (or placeholder). Hiding input field.'); newCaptainField.style.display = 'none'; newCaptainInput.required = false; newCaptainInput.value = ''; } }); }
        else { console.error("Error setting up captain selection: One or more elements (select, field div, input) not found."); }

        // --- Handle Search Input ---
         const searchBox = document.getElementById('search-box');
         const searchResultsList = document.getElementById('search-results-list');
         if (searchBox && searchResultsList) {
              searchBox.addEventListener('input', function() {
                   const searchTerm = this.value.trim().toLowerCase();
                   const profileDiv = document.getElementById('search-profile-content');
                   if (profileDiv) profileDiv.style.display = 'none';

                   if (searchTerm.length < 1) { // Show results even for 1 char
                       searchResultsList.innerHTML = ''; searchResultsList.style.display = 'none'; return;
                   }
                   if (!allSheetData) { searchResultsList.innerHTML = '<div>Data not loaded yet...</div>'; searchResultsList.style.display = 'block'; return; }

                   const matchingNames = Object.keys(captainProfiles).filter(name => name.toLowerCase().includes(searchTerm)).sort();
                   if (matchingNames.length > 0) {
                        let resultsHtml = ''; matchingNames.forEach(name => { resultsHtml += `<div onclick="showProfileView('${escapeHtml(name)}')">${escapeHtml(name)}</div>`; });
                        searchResultsList.innerHTML = resultsHtml; searchResultsList.style.display = 'block';
                   } else { searchResultsList.innerHTML = '<div>No matching captains found.</div>'; searchResultsList.style.display = 'block'; }
              });
         } else { console.error("Search box or results list not found!"); }

        // --- Dynamic Q&A Pairs ---
        let qaCounter = 0;
         function addQaPair() {
             qaCounter++; const qaContainer = document.getElementById('qa-container'); if (!qaContainer) { console.error("Q&A container not found!"); return; } const newPair = document.createElement('div'); newPair.classList.add('qa-pair'); newPair.id = `qa-pair-${qaCounter}`;
             newPair.innerHTML = ` <button type="button" class="button button-delete" onclick="deleteQaPair(${qaCounter})">X</button> <label for="question-${qaCounter}">Q${qaCounter}:</label> <textarea id="question-${qaCounter}" name="question_${qaCounter}" placeholder="Enter question..." rows="2"></textarea> <label for="answer-${qaCounter}">A${qaCounter}:</label> <textarea id="answer-${qaCounter}" name="answer_${qaCounter}" placeholder="Enter answer..." rows="3"></textarea>`;
             qaContainer.appendChild(newPair);
         }
         function deleteQaPair(pairId) {
              const pairElement = document.getElementById(`qa-pair-${pairId}`); if (pairElement) { pairElement.remove(); }
          }

        // --- Form Submission ---
        const entryForm = document.getElementById('entry-form');
        if (entryForm) {
            entryForm.addEventListener('submit', async function(event) {
                 event.preventDefault(); const submitButton = entryForm.querySelector('button[type="submit"]'); const originalButtonText = submitButton.textContent; submitButton.disabled = true; submitButton.textContent = 'Submitting...'; const formData = new FormData(entryForm); const data = { timestamp: new Date().toISOString(), captainName: '', appointment: formData.get('appointment') || '', experience: formData.get('experience') || '', dos: formData.get('dos') || '', donts: formData.get('donts') || '', rating: formData.get('rating') || '', questions: '' }; const questions = []; const selectedName = formData.get('captainNameSelect'); const newName = formData.get('captainNameNew')?.trim(); if (selectedName === '__add_new__') { if (!newName) { alert("Please enter the new Captain's Name."); submitButton.disabled = false; submitButton.textContent = originalButtonText; return; } data.captainName = newName; } else if (selectedName) { data.captainName = selectedName; } else { alert("Please select or add a Captain Name."); submitButton.disabled = false; submitButton.textContent = originalButtonText; return; } if (!data.appointment) { alert("Please select an Appointment."); submitButton.disabled = false; submitButton.textContent = originalButtonText; return; } if (!data.rating) { alert("Please select a Rating (Good Guy / Bad Guy)."); submitButton.disabled = false; submitButton.textContent = originalButtonText; return; }
                 const qaPairs = document.querySelectorAll('#qa-container .qa-pair'); qaPairs.forEach(pairDiv => { const qInput = pairDiv.querySelector('textarea[name^="question_"]'); const aInput = pairDiv.querySelector('textarea[name^="answer_"]'); if (qInput && aInput) { const q = qInput.value.trim(); const a = aInput.value.trim(); if (q || a) { questions.push({ q: q || '', a: a || '' }); } } }); data.questions = JSON.stringify(questions); console.log("Collected Form Data for POST:", data);
                 try { if (!WEB_APP_URL || WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') { throw new Error("Web App URL is not set correctly at the top of the script."); } const urlEncodedData = new URLSearchParams(data); const response = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', }, body: urlEncodedData }); const result = await response.json(); console.log("Response from Web App:", result); if (result.status === 'success') { alert("Entry submitted successfully!"); allSheetData = null; captainProfiles = {}; await fetchAllData(); entryForm.reset(); const qaContainer = document.getElementById('qa-container'); if(qaContainer) qaContainer.innerHTML = ''; qaCounter = 0; if(newCaptainField) newCaptainField.style.display = 'none'; showView('menu-view'); } else { throw new Error(result.message || "Unknown error from Apps Script."); } } catch (error) { console.error("Error submitting data:", error); alert(`Submission failed: ${error.message}`); } finally { submitButton.disabled = false; submitButton.textContent = originalButtonText; }
            });
         } else { console.error("Entry form not found!"); }

        // --- Authentication (Fetching Password from Sheet) ---
        async function checkPassword() {
            const enteredPassword = prompt("Enter Password:"); if (enteredPassword === null) { alert("Password entry cancelled."); return; } console.log("Attempting to fetch password from sheet..."); document.body.style.cursor = 'wait'; const passwordRange = `${PASSWORD_SHEET_NAME}!${PASSWORD_CELL}`; const passwordApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${passwordRange}?key=${API_KEY}`;
            try { const response = await fetch(passwordApiUrl); const responseData = await response.json(); if (!response.ok) { console.error("Error fetching password:", responseData); const error = responseData.error || {}; const message = error.message || response.statusText; throw new Error(`Could not fetch password from sheet: ${message}`); } const correctPasswordFromSheet = responseData.values?.[0]?.[0]; if (correctPasswordFromSheet === undefined || correctPasswordFromSheet === null) { throw new Error(`Password not found in ${PASSWORD_SHEET_NAME}!${PASSWORD_CELL}. Make sure it's set.`); } if (enteredPassword === correctPasswordFromSheet) { console.log("Password correct. Initializing app."); isAuthenticated = true; document.body.classList.add('unlocked'); await fetchAllData(); showView('menu-view'); } else { alert("Incorrect password."); } } catch (error) { console.error("Password check failed:", error); alert(`Authentication failed: ${error.message}`); } finally { document.body.style.cursor = 'default'; }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed. Checking password...");
             const savedDarkMode = localStorage.getItem('darkModePref');
             setDarkMode(savedDarkMode === 'true');
             checkPassword();
        });

    </script>

</body>
</html>
