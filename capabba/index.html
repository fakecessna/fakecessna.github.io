<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Database</title>
    <style>
        /* --- CSS Styles same as previous version --- */
        /* ... (All CSS rules from the previous version go here) ... */
        .container { display: none; /* Initially hidden for password */ }
        body.unlocked .container { display: block; }
        /* Ensure the add-captain-field is hidden initially if JS fails */
        #add-captain-field { display: none; margin-top: -5px; margin-bottom: 10px; }

    </style>
</head>
<body>

    <div class="header-controls">
        <label class="switch" title="Toggle Day/Night Mode">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
        </label>
    </div>

    <div class="container">
        <div id="menu-view" class="view active">
             <h2>Captain Database Menu</h2>
              <div class="menu-buttons">
                  <button class="button" onclick="showView('submit-view')">Submit New Entry</button>
                  <button class="button" onclick="showView('good-guys-view')">View Good Guys</button>
                  <button class="button" onclick="showView('bad-guys-view')">View Bad Guys</button>
                  <button class="button" onclick="showView('search-view')">Search Captains</button>
                  <button class="button" onclick="showView('abba-view')">ABBA Q&A Compilation</button>
              </div>
        </div>

        <div id="submit-view" class="view">
             <h2>Submit New Entry</h2>
             <form id="entry-form">
                 <div class="form-section">
                     <label for="captain-name-select">Captain Name</label>
                     <div class="captain-select-container">
                          <select id="captain-name-select" name="captainNameSelect" required>
                              <option value="" selected disabled>-- Select Existing or Add New --</option>
                              <option value="__add_new__">-- Add New Captain --</option>
                          </select>
                     </div>
                     <div id="add-captain-field">
                          <label for="captain-name-new">New Captain Name:</label>
                          <input type="text" id="captain-name-new" name="captainNameNew">
                     </div>
                 </div>
                 <div class="form-section">
                     <label for="appointment">Appointment (Your observation)</label>
                     <select id="appointment" name="appointment" required> <option value="" selected disabled>-- Select Appointment --</option> <option value="Line">Line</option> <option value="SUC">SUC</option> <option value="LIP">LIP</option> <option value="MGMT">MGMT</option> </select>
                 </div>
                 <div class="form-section"> <label for="experience">Experience / Remarks</label> <textarea id="experience" name="experience" placeholder="Share your overall experience, notable events, or general remarks..."></textarea> </div>
                 <div class="form-section"> <label for="dos">Do's</label> <textarea id="dos" name="dos" placeholder="What behaviours, techniques, or preferences are encouraged?"></textarea> </div>
                 <div class="form-section"> <label for="donts">Don'ts</label> <textarea id="donts" name="donts" placeholder="What behaviours, actions, or topics should be avoided?"></textarea> </div>
                 <div class="form-section"> <h3>Captain Specific Q&A</h3> <div id="qa-container"></div> <button type="button" class="button button-secondary" onclick="addQaPair()">Add Question</button> </div>
                 <div class="form-section radio-group"> <label>Rate This Interaction:</label> <label for="good-guy"><input type="radio" id="good-guy" name="rating" value="good" required> Good Guy</label> <label for="bad-guy"><input type="radio" id="bad-guy" name="rating" value="bad"> Bad Guy</label> </div>
                 <div class="form-section"> <button type="submit" class="button button-primary">Submit Entry</button> <button type="button" class="button button-back" onclick="showView('menu-view')">Back to Menu</button> </div>
             </form>
        </div>

        <div id="good-guys-view" class="view"> /* ... */ <h2>Good Guys List</h2> <div id="good-guys-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div> <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button> </div>
        <div id="bad-guys-view" class="view"> /* ... */ <h2>Bad Guys List</h2> <div id="bad-guys-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div> <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button> </div>
        <div id="search-view" class="view"> /* ... */ <h2>Search Captains</h2> <div id="search-dropdown-container" class="form-section"> <label for="search-captain-select">Select Captain to View Profile:</label> <select id="search-captain-select"><option value="" selected disabled>-- Select Captain --</option></select> </div> <div id="search-profile-content" class="profile-display" style="display: none;"></div> <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button> </div>
        <div id="abba-view" class="view"> /* ... */ <h2>ABBA Q&A Compilation</h2> <div id="abba-list-content" class="data-list"><div class="placeholder-content">Loading data...</div></div> <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button> </div>
        <div id="profile-view" class="view"> /* ... */ <h2 id="profile-view-captain-name">Captain Profile</h2> <div id="profile-view-content" class="profile-display"><div class="placeholder-content">Loading profile...</div></div> <button type="button" class="button button-back" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button> </div>

    </div> <script>
        // --- Credentials ---
        const API_KEY = 'AIzaSyA0JGGJAYg_xY8EpR-cVn4hVFKkZyji5ck';
        const SPREADSHEET_ID = '1JNwm0Tl2HpaDW6MJdrF_0bcTL7imtwvYldt1UDx1r3Q';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS42fKFx8_A2XL1Aa1nOAOpeelyz1w02T_nl1zF-cGXR1CwOvJSYaCiy06IKWTzBDPWA/exec';
        const PASSWORD_SHEET_NAME = 'Sheet2';
        const PASSWORD_CELL = 'A1';

        // --- Global Cache & State ---
        let allSheetData = null;
        let captainProfiles = {};
        let isFetching = false;
        let lastView = 'menu-view';
        let isAuthenticated = false;

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        function setDarkMode(isNight) { /* ... */ }
        if (darkModeToggle) { darkModeToggle.addEventListener('change', () => setDarkMode(darkModeToggle.checked)); }

        // --- Utility Functions ---
        function findMode(arr) { /* ... */ }
        function escapeHtml(unsafe) { /* ... */ }

        // --- Data Fetching & Processing ---
        async function fetchAllData() { /* ... */ }
        function processAllData() { /* ... */ }
        function populateSubmitDropdown() { /* ... */ }
        function populateSearchDropdown() { /* ... */ }

        // --- Display Logic for Views ---
        function displayList(type) { /* ... */ }
        function displayAbba() { /* ... */ }
        function displayCaptainProfile(captainName, targetDivId = 'search-profile-content') { /* ... */ }

        // --- View Switching & Control ---
        async function showView(viewId) { /* ... */ }
        function showProfileView(captainName) { /* ... */ }

        // --- Handle Captain Selection (Submit Form) --- << CHECK THIS BLOCK >>
        const captainSelect = document.getElementById('captain-name-select');
        const newCaptainField = document.getElementById('add-captain-field');
        const newCaptainInput = document.getElementById('captain-name-new');

        if (captainSelect && newCaptainField && newCaptainInput) { // Ensure all elements exist
            captainSelect.addEventListener('change', function() {
                // Add logs to see if this runs and what the value is
                console.log('Captain dropdown changed. Selected value:', this.value); // DEBUG LOG

                if (this.value === '__add_new__') {
                    console.log('Add New selected. Showing input field.'); // DEBUG LOG
                    newCaptainField.style.display = 'block'; // Show the div
                    newCaptainInput.required = true;
                    newCaptainInput.focus();
                } else {
                    console.log('Existing captain selected (or placeholder). Hiding input field.'); // DEBUG LOG
                    newCaptainField.style.display = 'none'; // Hide the div
                    newCaptainInput.required = false;
                    newCaptainInput.value = '';
                }
            });
        } else {
            console.error("Error setting up captain selection: One or more elements (select, field div, input) not found.");
        }
         // --- End Captain Selection Handler ---

        // --- Handle Search Captain Selection ---
        const searchCaptainSelect = document.getElementById('search-captain-select');
        if (searchCaptainSelect) { /* ... */ }

        // --- Dynamic Q&A Pairs ---
        let qaCounter = 0;
        function addQaPair() { /* ... */ }
        function deleteQaPair(pairId) { /* ... */ }

        // --- Form Submission ---
        const entryForm = document.getElementById('entry-form');
        if (entryForm) { /* ... */ }

        // --- Authentication ---
        async function checkPassword() { /* ... */ }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed. Checking password...");
             checkPassword();
             // Apply initial dark mode setting if needed (can be done before auth)
              const savedDarkMode = localStorage.getItem('darkModePref');
              setDarkMode(savedDarkMode === 'true');
             // The rest (fetching data, showing menu) is handled inside checkPassword() on success
        });

    </script>

</body>
</html>
