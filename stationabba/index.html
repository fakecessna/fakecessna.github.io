<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Database - Alpha</title>
    <style>
        /* Styles remain the same as the previous version */
        /* General Styles */
        :root { /* ... */ } html, body { /* ... */ } body.night-mode { /* ... */ } .header-controls { /* ... */ } .container { /* ... */ } body.night-mode .container { /* ... */ } .view { /* ... */ } .view.active { /* ... */ } @keyframes fadeIn { /* ... */ } h2, h3, h4 { /* ... */ } body.night-mode h2, body.night-mode h3, body.night-mode h4 { /* ... */ } .button { /* ... */ } .button:hover { /* ... */ } body.night-mode .button { /* ... */ } .button-secondary { /* ... */ } body.night-mode .button-secondary { /* ... */ } .button-delete { /* ... */ } body.night-mode .button-delete { /* ... */ } button:disabled { /* ... */ } body.night-mode button:disabled { /* ... */ } .menu-buttons button { /* ... */ } .form-section { /* ... */ } .form-section label { /* ... */ } body.night-mode .form-section label { /* ... */ } .form-section input[type="text"], .form-section input[type="search"], .form-section select, .form-section textarea { /* ... */ } body.night-mode .form-section input[type="text"], body.night-mode .form-section input[type="search"], body.night-mode .form-section select, body.night-mode .form-section textarea { /* ... */ } .form-section input[type="text"]:focus, .form-section input[type="search"]:focus, .form-section select:focus, .form-section textarea:focus { /* ... */ } body.night-mode .form-section input[type="text"]:focus, body.night-mode .form-section input[type="search"]:focus, body.night-mode .form-section select:focus, body.night-mode .form-section textarea:focus { /* ... */ }
        .top-row-layout { /* ... */ } .top-row-layout .form-section { /* ... */ } .top-row-layout #aircraft-type-section { /* ... */ } .top-row-layout #station-icao-section, .top-row-layout #station-iata-section { /* ... */ }
        #add-station-manual-fields { /* ... */ } body.night-mode #add-station-manual-fields { /* ... */ } #add-station-manual-fields .form-section { /* ... */ } @media (max-width: 768px) { /* ... */ }
        .sector-block { /* ... */ } body.night-mode .sector-block { /* ... */ } .sector-block h3 { /* ... */ } .sector-block .button-delete-sector { /* ... */ } body.night-mode .sector-block .button-delete-sector { /* ... */ }
        #flight-numbers-section-per-sector { /* ... */ } .flight-number-input-group { /* ... */ } .flight-number-input-group span.sq-prefix { /* ... */ } body.night-mode .flight-number-input-group span.sq-prefix { /* ... */ } .flight-number-input-group input[name^="flightNumber_S"] { /* ... */ } .flight-number-input-group .button-delete { /* ... */ }
        .briefing-section-adder { /* ... */ } body.night-mode .briefing-section-adder { /* ... */ } .briefing-section-adder label { /* ... */ } .briefing-section-adder select { /* ... */ }
        .dynamic-briefing-section { /* ... */ } body.night-mode .dynamic-briefing-section { /* ... */ } .dynamic-briefing-section h4 { /* ... */ } body.night-mode .dynamic-briefing-section h4 { /* ... */ } .dynamic-briefing-section .button-delete { /* ... */ }
        .editor-toolbar { /* ... */ } .editor-toolbar button { /* ... */ } body.night-mode .editor-toolbar button { /* ... */ } .editor-toolbar button:hover { /* ... */ } body.night-mode .editor-toolbar button:hover { /* ... */ } .editable-content { /* ... */ } body.night-mode .editable-content { /* ... */ } .editable-content:focus { /* ... */ } body.night-mode .editable-content:focus { /* ... */ }
        .switch { /* ... */ } .switch input { /* ... */ } .slider { /* ... */ } .slider:before { /* ... */ } input:checked + .slider { /* ... */ } input:focus + .slider { /* ... */ } input:checked + .slider:before { /* ... */ }
        .data-list, .search-results-display-area, #station-briefs-full-list-container, #view-brief-details-container, #print-area { /* ... */ } body.night-mode .data-list, body.night-mode .search-results-display-area, body.night-mode #station-briefs-full-list-container, body.night-mode #view-brief-details-container, body.night-mode #print-area { /* ... */ } #station-briefs-full-list-container ul { /* ... */ } #station-briefs-full-list-container li { /* ... */ } #station-briefs-full-list-container li:hover { /* ... */ } body.night-mode #station-briefs-full-list-container li { /* ... */ } body.night-mode #station-briefs-full-list-container li:hover { /* ... */ } #station-briefs-full-list-container li:last-child { /* ... */ }
        #view-brief-details-container .brief-detail-section { /* ... */ } body.night-mode #view-brief-details-container .brief-detail-section { /* ... */ } #view-brief-details-container .brief-detail-section:last-child { /* ... */ } #view-brief-details-container .brief-detail-section h5 { /* ... */ } body.night-mode #view-brief-details-container .brief-detail-section h5 { /* ... */ } #view-brief-details-container .brief-content { /* ... */ } body.night-mode #view-brief-details-container .brief-content { /* ... */ }
        @media print { /* ... */ } #print-view { display: none; }
    </style>
</head>
<body>

    <div class="header-controls"> <label class="switch" title="Toggle Day/Night Mode"> <input type="checkbox" id="darkModeToggle"> <span class="slider round"></span> </label> </div>

    <div class="container">
        <div id="menu-view" class="view active">
            <h2>Station Database</h2>
            <div class="menu-buttons"> <button class="button" onclick="showView('create-entry-view')">Create New Station Brief(s)</button> <button class="button" onclick="showView('browse-station-briefs-view')">Browse Station Briefs</button> </div>
        </div>

        <div id="create-entry-view" class="view">
            <h2>Create New Station Brief(s)</h2>
            <form id="station-entry-form">
                {/* --- Common Info --- */}
                <div class="top-row-layout">
                    <div class="form-section" id="aircraft-type-section"> <label for="aircraft-type">Aircraft Type</label> <select id="aircraft-type" name="aircraftType" required> <option value="" selected disabled>-- Select --</option> <option value="B737">B737</option> <option value="B787">B787</option> <option value="B777">B777</option> <option value="A350">A350</option> <option value="A380">A380</option> <option value="B747">B747</option> </select> </div>
                    <div class="form-section" id="station-icao-section"> <label for="station-icao">Station ICAO</label> <select id="station-icao" name="stationICAO"> <option value="" selected disabled>-- Select ICAO --</option> </select> </div>
                    <div class="form-section" id="station-iata-section"> <label for="station-iata">Station IATA</label> <select id="station-iata" name="stationIATA"> <option value="" selected disabled>-- Select IATA --</option> </select> </div>
                </div>
                <div id="add-station-manual-fields">
                     <p>Manually adding new station:</p> <div class="form-section"><label>New ICAO:</label><input type="text" name="stationICAONew" value=""></div> <div class="form-section"><label>New IATA:</label><input type="text" name="stationIATANew" value=""></div> <div class="form-section"><label>New Name:</label><input type="text" name="stationNameNew" value=""></div>
                </div>
                <hr>

                {/* --- Container for Dynamic Sector Blocks --- */}
                <div id="sectors-container">
                    {/* Sector blocks will be added here by JS */}
                </div>

                {/* --- Add Sector Button --- */}
                <div class="form-section"> <button type="button" class="button button-secondary" onclick="addSectorBlock()">+ Add Sector Brief</button> </div>
                <hr>

                {/* --- Final Save/Back Buttons --- */}
                <div class="form-section" style="margin-top:30px;"> <button type="submit" class="button">Save All Added Briefs</button> <button type="button" class="button button-secondary" onclick="showView('menu-view')">Back to Menu</button> </div>
            </form>
        </div>

        <div id="browse-station-briefs-view" class="view">
             <h2>Browse Station Briefs</h2> <div class="form-section"> <label for="search-station-input">Search Station Briefs:</label> <input type="search" id="search-station-input" value=""> </div>
             <div id="view-brief-details-container" style="display:none;"></div> <h3>All Station Briefs</h3> <div id="station-briefs-full-list-container"> <p>Loading...</p> </div>
             <button type="button" class="button button-secondary" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="print-view"><h2>Station Brief</h2><div id="print-content"></div></div>

    </div>

    <script>
        // --- Configuration ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyV76pZNEbhDsVTiLl4y-oNkfYFFpL6oE88GhlkQv99vtYvg9kar_vvsnbhgWLEideu/exec'; // !!! PASTE YOUR URL HERE !!!

        // --- Global State ---
        let previousView = 'menu-view'; let sectorBlockCounter = 0; let allFetchedBriefs = []; let currentlyViewedBrief = null; let briefingSectionCounter = 0;

        // --- Station Data ---
        const stationMasterList = [ /* ... list as before ... */ ];

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle'); function setDarkMode(isNight) { /* ... */ } if (darkModeToggle) { /* ... */ }

        // --- View Switching ---
        const viewBriefDetailsContainer = document.getElementById('view-brief-details-container'); const stationBriefsFullListContainer = document.getElementById('station-briefs-full-list-container'); const searchStationInputField = document.getElementById('search-station-input'); const browseViewH3 = document.querySelector('#browse-station-briefs-view h3');
        function showView(viewId) { /* ... logic as before ... */ }
        function resetCreateEntryForm() {
            const form = document.getElementById('station-entry-form'); if(form) form.reset();
            document.getElementById('sectors-container').innerHTML = ''; sectorBlockCounter = 0; briefingSectionCounter = 0;
            const manualFields = document.getElementById('add-station-manual-fields'); manualFields.style.display = 'none';
            document.getElementById('station-icao-new').required = false; document.getElementById('station-iata-new').required = false; document.getElementById('station-name-new').required = false;
            document.getElementById('station-icao-new').value = ""; document.getElementById('station-iata-new').value = ""; document.getElementById('station-name-new').value = "";
            document.getElementById('aircraft-type').selectedIndex = 0; document.getElementById('station-icao').selectedIndex = 0; document.getElementById('station-iata').selectedIndex = 0;
            addSectorBlock(); // Add the first sector block after reset
        }

        // --- Station Dropdowns ---
        const stationICAOSelect = document.getElementById('station-icao'); /* ... other vars ... */ function populateStationDropdowns() { /* ... */ } function handleStationSelectChange(changedSelect, otherSelect) { /* ... */ }
        stationICAOSelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); }); stationIATASelect.addEventListener('change', function() { handleStationSelectChange(this, stationICAOSelect); });

        // --- Sector Block Management ---
        const sectorsContainer = document.getElementById('sectors-container');
        const predefinedSectionTitles = { /* ... same titles ... */ };
        const sectionKeyMap = { /* ... same key map ... */ };

        function addSectorBlock() {
            sectorBlockCounter++; const sectorIndex = sectorBlockCounter; const sectorDiv = document.createElement('div'); sectorDiv.classList.add('sector-block'); sectorDiv.id = `sector-block-${sectorIndex}`; sectorDiv.dataset.sectorIndex = sectorIndex;
            const flightContainerId = `flight-numbers-container-S${sectorIndex}`; const sectionsContainerId = `active-briefing-sections-container-${sectorIndex}`; const sectionAdderId = `section-adder-${sectorIndex}`; const sectionSelectId = `add-section-select-${sectorIndex}`;
            let removeButtonHTML = ''; if (sectorIndex > 1) removeButtonHTML = `<button type="button" class="button button-delete button-delete-sector" onclick="removeSectorBlock(${sectorIndex})">Remove This Sector</button>`;

            // Note: Removed the explicit "Sector Identifier" input field
            sectorDiv.innerHTML = `
                ${removeButtonHTML}
                <h3>Sector ${sectorIndex} Details</h3>

                <div class="form-section" id="flight-numbers-section-per-sector-${sectorIndex}">
                    <label>Flight Number(s) Applicable (Sector ${sectorIndex} Identifier)</label>
                    <div id="${flightContainerId}">
                        <div class="flight-number-input-group"> <span class="sq-prefix">SQ</span> <input type="text" name="flightNumber_S${sectorIndex}[]" value=""> </div>
                    </div>
                    <button type="button" class="button button-secondary add-flight-no-btn" onclick="addFlightNumberField('${flightContainerId}', ${sectorIndex})" style="font-size: 0.8em; padding: 3px 8px; margin-top: 5px;">+ Flight No.</button>
                </div>
                <hr><h4>Briefing Sections (Sector ${sectorIndex})</h4>
                <div id="${sectionsContainerId}" class="active-briefing-sections-container-per-sector">
                     <div class="briefing-section-adder" id="${sectionAdderId}"> <label for="${sectionSelectId}">Add briefing section:</label> <select id="${sectionSelectId}" onchange="addSelectedBriefingSection(this, ${sectorIndex})"> <option value="" disabled selected>-- Select to Add --</option>${Object.keys(predefinedSectionTitles).map(key => `<option value="${key}">${predefinedSectionTitles[key]}</option>`).join('')}<option value="custom">Custom Section</option> </select> </div>
                </div>`;
            sectorsContainer.appendChild(sectorDiv);
        }
        function removeSectorBlock(sectorIndexToRemove) { /* ... same as before ... */ }
        function addFlightNumberField(containerId, sectorIndex) { /* ... same as before ... */ }
        function addSelectedBriefingSection(selectElement, sectorIndex) { /* ... same as before, adds simple section */ }
        function removeBriefingSection(sectionId) { /* ... same as before ... */ }
        function formatDoc(command, editorId, valueArgument = null) { /* ... same as before ... */ }

        // --- Form Submission (Multiple POSTs, one per sector block) ---
        const stationEntryForm = document.getElementById('station-entry-form');
        if (stationEntryForm) {
            stationEntryForm.addEventListener('submit', async function(event) {
                event.preventDefault(); const submitButton = stationEntryForm.querySelector('button[type="submit"]'); const btnTxt = submitButton.textContent;
                let isManual = stationICAOSelect.value === '__add_new__' || stationIATASelect.value === '__add_new__';
                // Basic validation for common fields
                if (!stationEntryForm.elements['aircraftType'].value) { alert("Select Aircraft Type."); return; } if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station or add manually."); return; } if (isManual && (!stationEntryForm.elements['stationICAONew'].value || !stationEntryForm.elements['stationNameNew'].value)) { alert("Manual entry needs ICAO & Name."); return; } if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station."); return; }
                const sectorBlocks = sectorsContainer.querySelectorAll('.sector-block'); if (sectorBlocks.length === 0) { alert("Add at least one sector brief."); return; }
                document.querySelectorAll('.editable-content').forEach(editor => { const hid = editor.id.replace('-content', '-value'); const hin = document.getElementById(hid); if (hin) hin.value = editor.innerHTML; }); // Update hidden fields
                submitButton.disabled = true; submitButton.textContent = 'Saving...'; let successfulSubmits = 0; let failedSubmits = 0; const submissionPromises = [];
                // Get common info once
                let stationInfoPayload; if (isManual) { /* ... create manual stationInfo JSON ... */ } else if (stationEntryForm.elements['stationICAO'].value) { /* ... find/create stationInfo JSON ... */ } else if (stationEntryForm.elements['stationIATA'].value) { /* ... find/create stationInfo JSON ... */ }
                const aircraftTypePayload = stationEntryForm.elements['aircraftType'].value;

                for (const sectorBlock of sectorBlocks) {
                    const sectorIndex = sectorBlock.dataset.sectorIndex; const payload = {};
                    // **Generate Sector Identifier from Flight Numbers**
                    const flightNumbers = []; sectorBlock.querySelectorAll(`input[name="flightNumber_S${sectorIndex}[]"]`).forEach(input => { if (input.value.trim()) flightNumbers.push(input.value.trim()); });
                    let sectorIdentifier = "(No Flights Listed)"; // Default
                    if (flightNumbers.length > 0) { sectorIdentifier = flightNumbers.map(fn => `SQ ${fn}`).join(' / '); }
                    payload.sectorIdentifier = sectorIdentifier; // Use generated identifier
                    // ** --- **
                    payload.stationInfo = stationInfoPayload; payload.aircraftType = aircraftTypePayload; payload.flightNumbers = JSON.stringify(flightNumbers); // Store actual numbers too
                    for (const key in sectionKeyMap) { const inputName = `${sectionKeyMap[key]}ContentValue_S${sectorIndex}`; const hiddenInput = sectorBlock.querySelector(`input[name="${inputName}"]`); payload[sectionKeyMap[key] + 'ContentValue'] = hiddenInput ? hiddenInput.value : ''; }
                    let customSections = []; const customTitles = sectorBlock.querySelectorAll(`input[name="customSectionTitle_S${sectorIndex}[]"]`); const customContents = sectorBlock.querySelectorAll(`input[name="customSectionContentValue_S${sectorIndex}[]"]`); customTitles.forEach((t, i) => customSections.push({ title: t.value, content: customContents[i]?.value || '' })); payload.customSections = JSON.stringify(customSections);
                    console.log(`Payload S${sectorIndex}:`, payload); // Check includes generated sectorIdentifier
                    submissionPromises.push( fetch(WEB_APP_URL, { method: 'POST', body: new URLSearchParams(payload), headers: {'Content-Type': 'application/x-www-form-urlencoded'} }).then(r=>r.json()).then(res => { if (res.status==='success'){successfulSubmits++; return true;} else {throw new Error(res.message||`S${sectorIndex} fail`);} }).catch(err => { failedSubmits++; console.error(`Err S${sectorIndex}:`, err); return false; }) );
                } // End loop
                await Promise.all(submissionPromises); alert(`${successfulSubmits} sector(s) saved. ${failedSubmits} failed.`);
                if (successfulSubmits > 0) { allFetchedBriefs = []; resetCreateEntryForm(); showView('browse-station-briefs-view'); }
                 else { submitButton.disabled = false; submitButton.textContent = btnTxt; }
            });
        }

        // --- Browse Station Briefs Logic ---
        function displayBriefDetails(briefId) { /* ... No change needed, already shows SectorIdentifier ... */ }
        function hideBriefDetails() { /* ... No change needed ... */ }
        async function loadAndDisplayAllBriefs(searchTerm = '') { /* ... No change needed, already shows SectorIdentifier ... */ }
        if (searchStationInputField) { /* ... No change needed ... */ }
        function printBriefDetails() { /* ... No change needed, already shows SectorIdentifier ... */ }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => { const savedDarkMode = localStorage.getItem('darkModePrefStationDB'); setDarkMode(savedDarkMode === 'true'); populateStationDropdowns(); resetCreateEntryForm(); showView('menu-view'); });
    </script>

</body>
</html>
