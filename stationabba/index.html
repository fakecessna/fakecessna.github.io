<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Database - Alpha</title>
    <style>
        /* Styles remain the same as provided in the previous response */
        /* General Styles */
        :root { /* ... */ }
        html, body { /* ... */ }
        body.night-mode { /* ... */ }
        .header-controls { /* ... */ }
        .container { /* ... */ }
        body.night-mode .container { /* ... */ }
        .view { /* ... */ }
        .view.active { /* ... */ }
        @keyframes fadeIn { /* ... */ }
        h2, h3, h4 { /* ... */ }
        body.night-mode h2, body.night-mode h3, body.night-mode h4 { /* ... */ }
        .button { /* ... */ }
        .button:hover { /* ... */ }
        body.night-mode .button { /* ... */ }
        .button-secondary { /* ... */ }
        body.night-mode .button-secondary { /* ... */ }
        .button-delete { /* ... */ }
        body.night-mode .button-delete { /* ... */ }
        button:disabled { /* ... */ }
        body.night-mode button:disabled { /* ... */ }
        .menu-buttons button { /* ... */ }
        .form-section { /* ... */ }
        .form-section label { /* ... */ }
        body.night-mode .form-section label { /* ... */ }
        .form-section input[type="text"], .form-section input[type="search"], .form-section select, .form-section textarea { /* ... */ }
        body.night-mode .form-section input[type="text"], body.night-mode .form-section input[type="search"], body.night-mode .form-section select, body.night-mode .form-section textarea { /* ... */ }
        .form-section input[type="text"]:focus, .form-section input[type="search"]:focus, .form-section select:focus, .form-section textarea:focus { /* ... */ }
        body.night-mode .form-section input[type="text"]:focus, body.night-mode .form-section input[type="search"]:focus, body.night-mode .form-section select:focus, body.night-mode .form-section textarea:focus { /* ... */ }
        .top-row-layout { /* ... */ }
        .top-row-layout .form-section { /* ... */ }
        .top-row-layout #aircraft-type-section { /* ... */ }
        .top-row-layout #station-icao-section, .top-row-layout #station-iata-section { /* ... */ }
        #flight-numbers-section- अकेला { /* ... */ }
        .flight-number-input-group { /* ... */ }
        .flight-number-input-group span.sq-prefix { /* ... */ }
        body.night-mode .flight-number-input-group span.sq-prefix { /* ... */ }
        .flight-number-input-group input[name="flightNumber[]"] { /* ... */ }
        .flight-number-input-group .button-delete { /* ... */ }
        #add-station-manual-fields { /* ... */ }
        body.night-mode #add-station-manual-fields { /* ... */ }
        #add-station-manual-fields .form-section { /* ... */ }
         @media (max-width: 768px) { /* ... */ }
        .briefing-section-adder { /* ... */ }
        body.night-mode .briefing-section-adder { /* ... */ }
        .briefing-section-adder label { /* ... */ }
        .briefing-section-adder select { /* ... */ }
        .dynamic-briefing-section { /* ... */ }
        body.night-mode .dynamic-briefing-section { /* ... */ }
        .dynamic-briefing-section h4 { /* ... */ }
        body.night-mode .dynamic-briefing-section h4 { /* ... */ }
        .dynamic-briefing-section .button-delete { /* ... */ }
        .editor-toolbar { /* ... */ }
        .editor-toolbar button { /* ... */ }
        body.night-mode .editor-toolbar button { /* ... */ }
        .editor-toolbar button:hover { /* ... */ }
        body.night-mode .editor-toolbar button:hover { /* ... */ }
        .editable-content { /* ... */ }
        body.night-mode .editable-content { /* ... */ }
        .editable-content:focus { /* ... */ }
        body.night-mode .editable-content:focus { /* ... */ }
        .switch { /* ... */ }
        .switch input { /* ... */ }
        .slider { /* ... */ }
        .slider:before { /* ... */ }
        input:checked + .slider { /* ... */ }
        input:focus + .slider { /* ... */ }
        input:checked + .slider:before { /* ... */ }
        .data-list, .search-results-display-area, #station-briefs-full-list-container, #view-brief-details-container, #print-area { /* ... */ }
        body.night-mode .data-list, body.night-mode .search-results-display-area, body.night-mode #station-briefs-full-list-container, body.night-mode #view-brief-details-container, body.night-mode #print-area { /* ... */ }
        #station-briefs-full-list-container ul { /* ... */ }
        #station-briefs-full-list-container li { /* ... */ }
        #station-briefs-full-list-container li:hover { /* ... */ }
        body.night-mode #station-briefs-full-list-container li { /* ... */ }
        body.night-mode #station-briefs-full-list-container li:hover { /* ... */ }
        #station-briefs-full-list-container li:last-child { /* ... */ }
        #view-brief-details-container .brief-detail-section { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section { /* ... */ }
        #view-brief-details-container .brief-detail-section:last-child { /* ... */ }
        #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        #view-brief-details-container .brief-content { /* ... */ }
        body.night-mode #view-brief-details-container .brief-content { /* ... */ }
        @media print { /* ... */ }
        #print-view { display: none; }
    </style>
</head>
<body>

    <div class="header-controls">
        <label class="switch" title="Toggle Day/Night Mode">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider round"></span>
        </label>
    </div>

    <div class="container">
        <div id="menu-view" class="view active">
            <h2>Station Database</h2>
            <div class="menu-buttons">
                <button class="button" onclick="showView('create-entry-view')">Create New Station Brief</button>
                <button class="button" onclick="showView('browse-station-briefs-view')">Browse Station Briefs</button>
            </div>
        </div>

        <div id="create-entry-view" class="view">
            <h2>Create New Station Brief</h2>
            <form id="station-entry-form">
                <div class="top-row-layout">
                    <div class="form-section" id="aircraft-type-section">
                        <label for="aircraft-type">Aircraft Type</label>
                        <select id="aircraft-type" name="aircraftType" required>
                            <option value="" selected disabled>-- Select --</option>
                            <option value="B737">B737</option>
                            <option value="B787">B787</option>
                            <option value="B777">B777</option>
                            <option value="A350">A350</option>
                            <option value="A380">A380</option>
                            <option value="B747">B747</option>
                        </select>
                    </div>
                    <div class="form-section" id="station-icao-section">
                        <label for="station-icao">Station ICAO</label>
                        <select id="station-icao" name="stationICAO">
                            <option value="" selected disabled>-- Select ICAO --</option>
                        </select>
                    </div>
                    <div class="form-section" id="station-iata-section">
                        <label for="station-iata">Station IATA</label>
                        <select id="station-iata" name="stationIATA">
                            <option value="" selected disabled>-- Select IATA --</option>
                        </select>
                    </div>
                </div>

                <div id="add-station-manual-fields">
                    <p style="margin-top:0; margin-bottom:10px; font-size:0.9em; color:var(--placeholder-text-day); width:100%;">Manually adding new station. Please provide details:</p>
                    <div class="form-section"><label for="station-icao-new">New Station ICAO:</label><input type="text" id="station-icao-new" name="stationICAONew" value=""></div>
                    <div class="form-section"><label for="station-iata-new">New Station IATA:</label><input type="text" id="station-iata-new" name="stationIATANew" value=""></div>
                    <div class="form-section"><label for="station-name-new">New Station Name:</label><input type="text" id="station-name-new" name="stationNameNew" value=""></div>
                </div>

                <div class="form-section" id="flight-numbers-section- अकेला">
                    <label>Flight Number(s) Applicable</label>
                    <div id="flight-numbers-container">
                        <div class="flight-number-input-group">
                            <span class="sq-prefix">SQ</span>
                            <input type="text" name="flightNumber[]" value="">
                        </div>
                    </div>
                    <button type="button" class="button button-secondary add-flight-no-btn" onclick="addFlightNumberField()" style="font-size: 0.8em; padding: 3px 8px; margin-top: 5px;">+ Flight No.</button>
                </div>

                 <div class="form-section" id="sector-identifier-section">
                    <label for="sector-identifier">Sector Identifier / Description</label>
                    <input type="text" id="sector-identifier" name="sectorIdentifier" required value="" placeholder="e.g., Outbound, Inbound, SQ123">
                 </div>

                <h3>Briefing Sections</h3>
                <div id="active-briefing-sections-container">
                     <div class="briefing-section-adder">
                        <label for="add-section-select">Choose a briefing section to add:</label>
                        <select id="add-section-select">
                            <option value="" disabled selected>-- Select to Add Section --</option>
                            <option value="station_overview">Station Overview</option>
                            <option value="operational_policy">Operational Policy</option>
                            <option value="preflight">Preflight</option>
                            <option value="pushback_taxi">Pushback & Taxi</option>
                            <option value="climb_enroute">Climb & Enroute</option>
                            <option value="arrival">Arrival</option>
                            <option value="taxi_in_parking">Taxi-In and Parking</option>
                            <option value="tem">Threat and Error Management (TEM)</option>
                            <option value="night_stop_info">Night Stop Information</option>
                            <option value="things_to_do">Things To Do</option>
                            <option value="custom">Custom Section</option>
                        </select>
                    </div>
                </div>

                <div class="form-section" style="margin-top:30px;">
                    <button type="submit" class="button">Save Station Brief</button>
                    <button type="button" class="button button-secondary" onclick="showView('menu-view')">Back to Menu</button>
                </div>
            </form>
        </div>

        <div id="browse-station-briefs-view" class="view">
            <h2>Browse Station Briefs</h2>
            <div class="form-section">
                <label for="search-station-input">Search Station Briefs:</label>
                <input type="search" id="search-station-input" value="">
            </div>
            <div id="view-brief-details-container" style="display:none;"></div>
            <h3>All Station Briefs</h3>
            <div id="station-briefs-full-list-container"><p>Loading all available station briefs...</p></div>
            <button type="button" class="button button-secondary" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="print-view"><h2>Station Brief</h2><div id="print-content"></div></div>

    </div>

    <script>
        // --- Configuration ---
        // !!! PASTE YOUR DEPLOYED WEB APP URL HERE !!!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyV76pZNEbhDsVTiLl4y-oNkfYFFpL6oE88GhlkQv99vtYvg9kar_vvsnbhgWLEideu/exec';
        // !!! --- !!!

        // --- Global State ---
        let previousView = 'menu-view';
        let activeBriefingSectionCounter = 0;
        let allFetchedBriefs = []; // Cache for fetched briefs
        let currentlyViewedBrief = null; // Store data of brief being viewed for printing

        // --- Station Data (For Dropdowns) ---
        const stationMasterList = [ { icao: "WSSS", iata: "SIN", name: "Singapore Changi Airport" }, { icao: "WADD", iata: "DPS", name: "Denpasar Ngurah Rai Int'l" }, { icao: "WIDD", iata: "BTH", name: "Batam Hang Nadim Int'l" }, { icao: "WMKJ", iata: "JHB", name: "Johor Bahru Senai Int'l" }, { icao: "WSAP", iata: "XSP", name: "Singapore Seletar Airport" }, { icao: "VVTS", iata: "SGN", name: "Ho Chi Minh City Tan Son Nhat Int'l" }, { icao: "YPPH", iata: "PER", name: "Perth Airport" }, { icao: "YPAD", iata: "ADL", name: "Adelaide Airport" }, { icao: "VIDP", iata: "DEL", name: "Delhi Indira Gandhi Int'l" }, { icao: "VGHS", iata: "DAC", name: "Dhaka Hazrat Shahjalal Int'l" }, { icao: "VCBI", iata: "CMB", name: "Colombo Bandaranaike Int'l" }, { icao: "VOMM", iata: "MAA", name: "Chennai Int'l Airport" }, { icao: "RKSI", iata: "ICN", name: "Seoul Incheon Int'l" }, { icao: "RJBB", iata: "KIX", name: "Osaka Kansai Int'l" }, { icao: "RJAA", iata: "NRT", name: "Tokyo Narita Int'l" }, { icao: "RJFF", iata: "FUK", name: "Fukuoka Airport" }, { icao: "RJGG", iata: "NGO", name: "Nagoya Chubu Centrair Int'l" }, { icao: "VTBS", iata: "BKK", name: "Bangkok Suvarnabhumi Airport" }, { icao: "ZBAA", iata: "PEK", name: "Beijing Capital Int'l" }, { icao: "ZBAD", iata: "PKX", name: "Beijing Daxing Int'l" }, { icao: "ZSPD", iata: "PVG", name: "Shanghai Pudong Int'l" }, { icao: "ZGGG", iata: "CAN", name: "Guangzhou Baiyun Int'l" }, { icao: "ZGSZ", iata: "SZX", name: "Shenzhen Bao'an Int'l" }, { icao: "ROAH", iata: "OKA", name: "Okinawa Naha Airport" }, { icao: "RCKH", iata: "KHH", name: "Kaohsiung Int'l Airport" }, { icao: "VNKT", iata: "KTM", name: "Kathmandu Tribhuvan Int'l" }, { icao: "VRMM", iata: "MLE", name: "Malé Velana Int'l Airport" }, { icao: "VDPP", iata: "PNH", name: "Phnom Penh Int'l Airport" }, { icao: "RPLL", iata: "MNL", name: "Manila Ninoy Aquino Int'l" }, { icao: "RCTP", iata: "TPE", name: "Taipei Taoyuan Int'l" }, { icao: "VHHH", iata: "HKG", name: "Hong Kong Int'l Airport" }, { icao: "VABB", iata: "BOM", name: "Mumbai Chhatrapati Shivaji Maharaj Int'l" }, { icao: "YSSY", iata: "SYD", name: "Sydney Kingsford Smith" }, { icao: "YMML", iata: "MEL", name: "Melbourne Tullamarine" }, { icao: "YBBN", iata: "BNE", name: "Brisbane Airport" }, { icao: "NZAA", iata: "AKL", name: "Auckland Airport" }, { icao: "NZCH", iata: "CHC", name: "Christchurch Int'l" }, { icao: "EGLL", iata: "LHR", name: "London Heathrow Airport" }, { icao: "EGCC", iata: "MAN", name: "Manchester Airport" }, { icao: "EDDF", iata: "FRA", name: "Frankfurt Airport" }, { icao: "EDDM", iata: "MUC", name: "Munich Airport" }, { icao: "LFPG", iata: "CDG", name: "Paris Charles de Gaulle Airport" }, { icao: "EHAM", iata: "AMS", name: "Amsterdam Airport Schiphol" }, { icao: "LSZH", iata: "ZRH", name: "Zurich Airport" }, { icao: "LIRF", iata: "FCO", name: "Rome Fiumicino Airport" }, { icao: "LIMC", iata: "MXP", name: "Milan Malpensa Airport" }, { icao: "LEMD", iata: "MAD", name: "Madrid Barajas Airport" }, { icao: "LEBL", iata: "BCN", name: "Barcelona El Prat Airport" }, { icao: "EKCH", iata: "CPH", name: "Copenhagen Airport" }, { icao: "LTFM", iata: "IST", name: "Istanbul Airport" }, { icao: "OMDB", iata: "DXB", name: "Dubai Int'l Airport" }, { icao: "VOBL", iata: "BLR", name: "Bengaluru Kempegowda Int'l" }, { icao: "VOHS", iata: "HYD", name: "Hyderabad Rajiv Gandhi Int'l" }, { icao: "WMKK", iata: "KUL", name: "Kuala Lumpur Int'l Airport" }, { icao: "WIII", iata: "CGK", name: "Jakarta Soekarno-Hatta Int'l" }, { icao: "RJTT", iata: "HND", name: "Tokyo Haneda Airport" }, { icao: "FAOR", iata: "JNB", name: "Johannesburg O.R. Tambo Int'l" }, { icao: "FACT", iata: "CPT", name: "Cape Town Int'l Airport" }, { icao: "KLAX", iata: "LAX", name: "Los Angeles Int'l" }, { icao: "KSFO", iata: "SFO", name: "San Francisco Int'l" }, { icao: "KJFK", iata: "JFK", name: "New York JFK Int'l" }, { icao: "KEWR", iata: "EWR", name: "Newark Liberty Int'l" }, { icao: "KSEA", iata: "SEA", name: "Seattle-Tacoma Int'l" }, { icao: "KIAH", iata: "IAH", name: "Houston George Bush Int'l" } ];

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        function setDarkMode(isNight) { if (isNight) { document.body.classList.add('night-mode'); localStorage.setItem('darkModePrefStationDB', 'true'); if(darkModeToggle) darkModeToggle.checked = true; } else { document.body.classList.remove('night-mode'); localStorage.setItem('darkModePrefStationDB', 'false'); if(darkModeToggle) darkModeToggle.checked = false; } }
        if (darkModeToggle) { darkModeToggle.addEventListener('change', () => setDarkMode(darkModeToggle.checked)); }

        // --- View Switching & Control ---
        const viewBriefDetailsContainer = document.getElementById('view-brief-details-container');
        const stationBriefsFullListContainer = document.getElementById('station-briefs-full-list-container');
        const searchStationInputField = document.getElementById('search-station-input');
        const browseViewH3 = document.querySelector('#browse-station-briefs-view h3');

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const activeView = document.getElementById(viewId);
            if (activeView) activeView.classList.add('active');
            else document.getElementById('menu-view').classList.add('active');

            if (previousView === 'create-entry-view' && viewId !== 'create-entry-view') resetCreateEntryForm();

            if (viewId === 'browse-station-briefs-view') {
                viewBriefDetailsContainer.style.display = 'none';
                stationBriefsFullListContainer.style.display = 'block';
                searchStationInputField.style.display = 'block';
                if(browseViewH3) browseViewH3.style.display = 'block';
                loadAndDisplayAllBriefs();
            }
            previousView = viewId;
        }

        function resetCreateEntryForm() {
            const form = document.getElementById('station-entry-form'); if(form) form.reset();
            const flightNumbersContainer = document.getElementById('flight-numbers-container');
            while (flightNumbersContainer.children.length > 1) flightNumbersContainer.removeChild(flightNumbersContainer.lastChild);
            const firstFlightInput = flightNumbersContainer.querySelector('input[name="flightNumber[]"]'); if(firstFlightInput) firstFlightInput.value = "";
            document.getElementById('active-briefing-sections-container').querySelectorAll('.dynamic-briefing-section').forEach(el => el.remove()); // Remove sections, leave adder
            activeBriefingSectionCounter = 0;
            const manualFields = document.getElementById('add-station-manual-fields'); manualFields.style.display = 'none';
            document.getElementById('station-icao-new').required = false; document.getElementById('station-iata-new').required = false; document.getElementById('station-name-new').required = false;
            document.getElementById('station-icao-new').value = ""; document.getElementById('station-iata-new').value = ""; document.getElementById('station-name-new').value = "";
            document.getElementById('sector-identifier').value = ""; // Clear sector identifier
            document.getElementById('aircraft-type').selectedIndex = 0; document.getElementById('station-icao').selectedIndex = 0; document.getElementById('station-iata').selectedIndex = 0; document.getElementById('add-section-select').selectedIndex = 0;
        }

        // --- Dynamic Fields for "Create New Entry" ---
        function addFlightNumberField() { /* ... as before ... */ }

        // --- Populate Station Dropdowns & Handle Linking ---
        const stationICAOSelect = document.getElementById('station-icao');
        const stationIATASelect = document.getElementById('station-iata');
        const manualStationFieldsDiv = document.getElementById('add-station-manual-fields');
        const stationICAONewInput = document.getElementById('station-icao-new');
        const stationIATANewInput = document.getElementById('station-iata-new');
        const stationNameNewInput = document.getElementById('station-name-new');

        function populateStationDropdowns() { /* ... includes sorting, as before ... */ }
        function handleStationSelectChange(changedSelect, otherSelect) { /* ... as before ... */ }
        stationICAOSelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); });
        stationIATASelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); });

        // --- Briefing Section Management (Simplified - Single Sector per Entry) ---
        const addSectionSelect = document.getElementById('add-section-select');
        const activeSectionsContainer = document.getElementById('active-briefing-sections-container');
        const sectionAdderElement = document.querySelector('.briefing-section-adder');

        const predefinedSectionTitles = { station_overview: "Station Overview", operational_policy: "Operational Policy", preflight: "Preflight", pushback_taxi: "Pushback & Taxi", climb_enroute: "Climb & Enroute", arrival: "Arrival", taxi_in_parking: "Taxi-In and Parking", tem: "Threat and Error Management (TEM)", night_stop_info: "Night Stop Information", things_to_do: "Things To Do" };
        const sectionKeyMap = { station_overview: "StationOverview", operational_policy: "OperationalPolicy", preflight: "Preflight", pushback_taxi: "PushbackTaxi", climb_enroute: "ClimbEnroute", arrival: "Arrival", taxi_in_parking: "TaxiInParking", tem: "TEM", night_stop_info: "NightStopInfo", things_to_do: "ThingsToDo" };

        addSectionSelect.addEventListener('change', function() {
            const sectionValue = this.value; if (!sectionValue) return;
            const sectionKey = sectionValue !== 'custom' ? sectionKeyMap[sectionValue] : null;
            if (sectionValue !== 'custom' && activeSectionsContainer.querySelector(`.dynamic-briefing-section[data-section-key="${sectionValue}"]`)) { alert(`"${predefinedSectionTitles[sectionValue]}" section already added.`); this.value = ""; return; }

            activeBriefingSectionCounter++;
            const sectionIdBase = (sectionValue === 'custom') ? `custom-section-${activeBriefingSectionCounter}` : `briefing-section-${sectionValue}`;
            const sectionContainer = document.createElement('div'); sectionContainer.classList.add('dynamic-briefing-section'); sectionContainer.id = sectionIdBase;
            if (sectionValue !== 'custom') { sectionContainer.dataset.sectionKey = sectionValue; }

            let sectionTitleText = (sectionValue === 'custom') ? `Custom Section ${activeBriefingSectionCounter}` : predefinedSectionTitles[sectionValue];
            const isCustom = (sectionValue === 'custom');
            const editorId = `${sectionIdBase}-content`;
            const hiddenInputName = isCustom ? 'customSectionContentValue[]' : `${sectionKey}ContentValue`;
            const hiddenInputId = `${sectionIdBase}-value`;
            const titleInputName = isCustom ? 'customSectionTitle[]' : '';

            sectionContainer.innerHTML = `
                <button type="button" class="button button-delete" onclick="removeBriefingSection('${sectionIdBase}')">Remove</button>
                ${isCustom ? `<label for="title-${sectionIdBase}">Section Title:</label><input type="text" id="title-${sectionIdBase}" name="${titleInputName}" value="${sectionTitleText}" style="margin-bottom:10px; font-weight:bold;">` : `<h4>${sectionTitleText}</h4>`}
                <div class="editor-toolbar">
                    <button type="button" title="Bold" onclick="formatDoc('bold','${editorId}');"><b>B</b></button>
                    <button type="button" title="Italic" onclick="formatDoc('italic','${editorId}');"><i>I</i></button>
                    <button type="button" title="Underline" onclick="formatDoc('underline','${editorId}');"><u>U</u></button>
                    <button type="button" title="Unordered List" onclick="formatDoc('insertUnorderedList','${editorId}');">&bull;&equiv;</button>
                </div>
                <div id="${editorId}" class="editable-content" contenteditable="true"></div>
                <input type="hidden" name="${hiddenInputName}" id="${hiddenInputId}">`;

            activeSectionsContainer.insertBefore(sectionContainer, sectionAdderElement); // Insert before adder
            this.value = "";
        });

        function removeBriefingSection(sectionId) { const el = document.getElementById(sectionId); if (el) el.remove(); }
        function formatDoc(command, editorId, valueArgument = null) { const editor = document.getElementById(editorId); if (editor) { editor.focus(); document.execCommand(command, false, valueArgument); } else console.error("Editor not found:", editorId); }

        // --- Form Submission ---
        const stationEntryForm = document.getElementById('station-entry-form');
        if (stationEntryForm) {
            stationEntryForm.addEventListener('submit', function(event) {
                event.preventDefault();
                document.querySelectorAll('.editable-content').forEach(editor => { const hid = editor.id.replace('-content', '-value'); const hin = document.getElementById(hid); if (hin) hin.value = editor.innerHTML; });
                const formData = new FormData(stationEntryForm); const payload = {};
                let isManual = stationICAOSelect.value === '__add_new__' || stationIATASelect.value === '__add_new__';
                // --- Validation ---
                if (!formData.get('aircraftType')) { alert("Select Aircraft Type."); return; }
                if (!isManual && !formData.get('stationICAO') && !formData.get('stationIATA')) { alert("Select station or add manually."); return; }
                if (isManual && (!formData.get('stationICAONew') || !formData.get('stationNameNew'))) { alert("Manual entry needs ICAO & Name."); return; }
                if (!isManual && !formData.get('stationICAO') && !formData.get('stationIATA')) { alert("Select station."); return; }
                if (!formData.get('sectorIdentifier')) { alert("Please enter a Sector Identifier / Description."); document.getElementById('sector-identifier').focus(); return; }
                // --- End Validation ---
                if (isManual) { payload.stationInfo = JSON.stringify({ icao: formData.get('stationICAONew').toUpperCase(), iata: formData.get('stationIATANew').toUpperCase() || '', name: formData.get('stationNameNew') }); }
                else if (formData.get('stationICAO')) { const f = stationMasterList.find(s=>s.icao===formData.get('stationICAO')); payload.stationInfo = JSON.stringify(f ? {...f} : {icao: formData.get('stationICAO'), iata: formData.get('stationIATA')||'', name:'N/A'}); }
                else if (formData.get('stationIATA')) { const f = stationMasterList.find(s=>s.iata===formData.get('stationIATA')); payload.stationInfo = JSON.stringify(f ? {...f} : {icao: '', iata: formData.get('stationIATA'), name:'N/A'}); }
                payload.aircraftType = formData.get('aircraftType'); payload.sectorIdentifier = formData.get('sectorIdentifier'); payload.flightNumbers = JSON.stringify(formData.getAll("flightNumber[]").filter(fn => fn.trim() !== ""));
                for (const key in sectionKeyMap) payload[`${sectionKeyMap[key]}ContentValue`] = formData.get(`${sectionKeyMap[key]}ContentValue`) || '';
                let custSect = []; formData.getAll('customSectionTitle[]').forEach((t, i) => custSect.push({ title: t, content: formData.getAll('customSectionContentValue[]')[i] || '' }));
                payload.customSections = JSON.stringify(custSect);
                console.log("Payload:", payload);
                const submitButton = stationEntryForm.querySelector('button[type="submit"]'); const btnTxt = submitButton.textContent; submitButton.disabled = true; submitButton.textContent = 'Saving...';
                fetch(WEB_APP_URL, { method: 'POST', body: new URLSearchParams(payload), headers: {'Content-Type': 'application/x-www-form-urlencoded'} })
                .then(res => res.json()).then(res => { console.log('Save Success:', res); if (res.status === 'success') { alert('Brief saved! ID: ' + res.briefId); allFetchedBriefs = []; resetCreateEntryForm(); showView('browse-station-briefs-view'); } else { throw new Error(res.message); } })
                .catch(err => { console.error('Save Error:', err); alert('Error: ' + err.message); })
                .finally(() => { submitButton.disabled = false; submitButton.textContent = btnTxt; });
            });
        }

        // --- Browse Station Briefs Logic ---
        function displayBriefDetails(briefId) {
            currentlyViewedBrief = allFetchedBriefs.find(b => String(b.rowId) === String(briefId));
            if (!currentlyViewedBrief) { /* ... */ return; }
            const brief = currentlyViewedBrief; let detailsHtml = `<div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;"><button type="button" class="button button-secondary" onclick="hideBriefDetails()">Back to List</button><button type="button" class="button" onclick="printBriefDetails()">Print Brief</button></div>`;
            detailsHtml += `<h4>Brief: ${brief.stationInfo?.icao || 'N/A'} (${brief.stationInfo?.name || 'N/A'}) - ${brief.AircraftType || 'N/A'}</h4>`;
            detailsHtml += `<p><strong>Sector / Context:</strong> ${brief.SectorIdentifier || 'N/A'}</p>`; detailsHtml += `<p><strong>Last Updated:</strong> ${brief.LastUpdated || 'N/A'}</p>`;
            if (brief.FlightNumbers && brief.FlightNumbers.length > 0) { detailsHtml += `<p><strong>Flight Number(s):</strong> SQ ${brief.FlightNumbers.join(', SQ ')}</p>`; }
            const sKeys = { StationOverview: "Station Overview", OperationalPolicy: "Operational Policy", Preflight: "Preflight", PushbackTaxi: "Pushback & Taxi", ClimbEnroute: "Climb & Enroute", Arrival: "Arrival", TaxiInParking: "Taxi-In and Parking", TEM: "TEM", NightStopInfo: "Night Stop Information", ThingsToDo: "Things To Do" };
            let contentFound = false;
            for (const k in sKeys) { if (brief[k] && String(brief[k]).trim() !== "" && String(brief[k]).trim() !== "<div></div>") { detailsHtml += `<div class="brief-detail-section"><h5>${sKeys[k]}</h5><div class="brief-content">${brief[k]}</div></div>`; contentFound = true; } }
            if (brief.CustomSections && brief.CustomSections.length > 0) { brief.CustomSections.forEach(c => { if(c.content && c.content.trim() !== "" && c.content.trim() !== "<div></div>") { detailsHtml += `<div class="brief-detail-section"><h5>${c.title||'Custom'}</h5><div class="brief-content">${c.content}</div></div>`; contentFound = true; } }); }
            if (!contentFound) detailsHtml += `<p><i>No specific briefing sections entered.</i></p>`;
            viewBriefDetailsContainer.innerHTML = detailsHtml; viewBriefDetailsContainer.style.display = 'block'; stationBriefsFullListContainer.style.display = 'none'; searchStationInputField.style.display = 'none'; if(browseViewH3) browseViewH3.style.display = 'none';
        }
        function hideBriefDetails() { viewBriefDetailsContainer.style.display = 'none'; stationBriefsFullListContainer.style.display = 'block'; searchStationInputField.style.display = 'block'; if(browseViewH3) browseViewH3.style.display = 'block'; loadAndDisplayAllBriefs(searchStationInputField.value.trim()); }

        async function loadAndDisplayAllBriefs(searchTerm = '') {
            stationBriefsFullListContainer.innerHTML = '<p>Loading available station briefs...</p>'; searchResultsDisplayArea.style.display = 'none';
            if (!WEB_APP_URL || WEB_APP_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE') { stationBriefsFullListContainer.innerHTML = '<p style="color:red;">Error: Web App URL not configured.</p>'; return; }
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getAllBriefs`); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json(); if (result.status !== 'success') throw new Error(result.message);
                allFetchedBriefs = result.data.map(b => ({...b, stationInfo: typeof b.stationInfo==='string' ? JSON.parse(b.stationInfo||'{}'):b.stationInfo||{}, FlightNumbers: Array.isArray(b.FlightNumbers)?b.FlightNumbers:[], CustomSections: Array.isArray(b.CustomSections)?b.CustomSections:[] }));
            } catch (error) { console.error("Fetch Error:", error); stationBriefsFullListContainer.innerHTML = `<p>Error loading briefs: ${error.message}.</p>`; return; }
            let briefsToDisplay = [...allFetchedBriefs];
            if (searchTerm) { const lSearch = searchTerm.toLowerCase(); briefsToDisplay = briefsToDisplay.filter(b => (b.stationInfo.icao?.toLowerCase().includes(lSearch)) || (b.stationInfo.iata?.toLowerCase().includes(lSearch)) || (b.stationInfo.name?.toLowerCase().includes(lSearch)) || (b.AircraftType?.toLowerCase().includes(lSearch)) || (b.SectorIdentifier?.toLowerCase().includes(lSearch)) || (b.FlightNumbers?.some(fn => fn.toLowerCase().includes(lSearch))) ); }
            if (briefsToDisplay.length === 0) { stationBriefsFullListContainer.innerHTML = `<p>No briefs found${searchTerm ? ' matching criteria' : ''}.</p>`; return; }
            let listHtml = '<ul>'; briefsToDisplay.sort((a,b)=>(a.stationInfo.icao||"").localeCompare(b.stationInfo.icao||"")).forEach(b=>{const i=b.stationInfo?.icao||'N/A';const n=b.stationInfo?.name||'N/A';const a=b.AircraftType||'N/A';const u=b.LastUpdated||'N/A';const f=b.FlightNumbers?.length>0?`(SQ ${b.FlightNumbers.join('/')})`:'';const s=b.SectorIdentifier||'General';const id=b.rowId||b.BriefID;if(id){listHtml+=`<li onclick="displayBriefDetails('${id}')"><strong>${i} (${n})</strong> [${s}] - ${a}${f} - <em>Updated: ${u}</em></li>`;}else{listHtml+=`<li><strong>${i} (${n})</strong> [${s}] - ${a}${f} - <em>Updated: ${u}</em> (No ID)</li>`;}}); listHtml += '</ul>'; stationBriefsFullListContainer.innerHTML = listHtml;
        }
        if (searchStationInputField) { searchStationInputField.addEventListener('input', function() { const s=this.value.trim(); viewBriefDetailsContainer.style.display='none'; stationBriefsFullListContainer.style.display='block'; if(browseViewH3)browseViewH3.style.display='block'; if(s.length===0)loadAndDisplayAllBriefs(); else if(s.length>=1)loadAndDisplayAllBriefs(s); }); }

        // --- Print Functionality ---
        function printBriefDetails() {
            if (!currentlyViewedBrief) { alert("No brief viewed."); return; } const brief = currentlyViewedBrief; const printDiv = document.getElementById('print-content');
            let printHtml = `<h2>Station Brief: ${brief.stationInfo?.icao || 'N/A'} (${brief.stationInfo?.name || 'N/A'})</h2>`; printHtml += `<p><strong>Aircraft Type:</strong> ${brief.AircraftType || 'N/A'}</p>`; printHtml += `<p><strong>Sector / Context:</strong> ${brief.SectorIdentifier || 'N/A'}</p>`; printHtml += `<p><strong>Last Updated:</strong> ${brief.LastUpdated || 'N/A'}</p>`; if (brief.FlightNumbers && brief.FlightNumbers.length > 0) printHtml += `<p><strong>Flight Number(s):</strong> SQ ${brief.FlightNumbers.join(', SQ ')}</p>`; printHtml += "<hr>";
            const sKeys = { StationOverview: "Station Overview", OperationalPolicy: "Operational Policy", Preflight: "Preflight", PushbackTaxi: "Pushback & Taxi", ClimbEnroute: "Climb & Enroute", Arrival: "Arrival", TaxiInParking: "Taxi-In and Parking", TEM: "TEM", NightStopInfo: "Night Stop Information", ThingsToDo: "Things To Do" }; let hasContent = false;
            for (const k in sKeys) { if (brief[k] && String(brief[k]).trim() !== "" && String(brief[k]).trim() !== "<div></div>") { printHtml += `<h4>${sKeys[k]}</h4><div>${brief[k]}</div>`; hasContent = true; } }
            if (brief.CustomSections && brief.CustomSections.length > 0) { brief.CustomSections.forEach(c => { if(c.content && c.content.trim() !== "" && c.content.trim() !== "<div></div>") { printHtml += `<h4>${c.title||'Custom'}</h4><div>${c.content}</div>`; hasContent = true; } }); } if (!hasContent) printHtml += `<p><i>No specific briefing sections entered.</i></p>`;
            printDiv.innerHTML = printHtml; window.print();
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedDarkMode = localStorage.getItem('darkModePrefStationDB'); setDarkMode(savedDarkMode === 'true');
            populateStationDropdowns();
            if (sectionAdderElement) activeSectionsContainer.appendChild(sectionAdderElement); // Ensure adder is at end
            showView('menu-view');
        });
    </script>
</body>
</html>
