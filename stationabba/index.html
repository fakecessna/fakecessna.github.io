<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Database - Alpha</title>
    <style>
        /* Styles including updates for dynamic tabs */
        :root { /* ... CSS Variables ... */ }
        html, body { /* ... */ }
        body.night-mode { /* ... */ }
        .header-controls { /* ... */ }
        .container { /* ... */ }
        body.night-mode .container { /* ... */ }
        .view { /* ... */ }
        .view.active { /* ... */ }
        @keyframes fadeIn { /* ... */ }
        h2, h3, h4 { /* ... */ }
        body.night-mode h2, body.night-mode h3, body.night-mode h4 { /* ... */ }
        .button { /* ... */ }
        .button:hover { /* ... */ }
        body.night-mode .button { /* ... */ }
        .button-secondary { /* ... */ }
        body.night-mode .button-secondary { /* ... */ }
        .button-delete { /* ... */ }
        body.night-mode .button-delete { /* ... */ }
        button:disabled { /* ... */ }
        body.night-mode button:disabled { /* ... */ }
        .menu-buttons button { /* ... */ }
        .form-section { /* ... */ }
        .form-section label { /* ... */ }
        body.night-mode .form-section label { /* ... */ }
        .form-section input[type="text"], .form-section input[type="search"], .form-section select, .form-section textarea { /* ... */ }
        body.night-mode .form-section input[type="text"], body.night-mode .form-section input[type="search"], body.night-mode .form-section select, body.night-mode .form-section textarea { /* ... */ }
        .form-section input[type="text"]:focus, .form-section input[type="search"]:focus, .form-section select:focus, .form-section textarea:focus { /* ... */ }
        body.night-mode .form-section input[type="text"]:focus, body.night-mode .form-section input[type="search"]:focus, body.night-mode .form-section select:focus, body.night-mode .form-section textarea:focus { /* ... */ }

        .top-row-layout { /* ... */ }
        .top-row-layout .form-section { /* ... */ }
        .top-row-layout #aircraft-type-section { /* ... */ }
        .top-row-layout #station-icao-section, .top-row-layout #station-iata-section { /* ... */ }

        #add-station-manual-fields { /* ... */ }
        body.night-mode #add-station-manual-fields { /* ... */ }
        #add-station-manual-fields .form-section { /* ... */ }
         @media (max-width: 768px) { /* ... */ }

        /* Sector Block Styling (Removed - Using Tabs Now) */

        /* Flight numbers are now per-sector, handled within the dynamic section */
         .flight-number-input-group { /* ... */ }
         .flight-number-input-group span.sq-prefix { /* ... */ }
         body.night-mode .flight-number-input-group span.sq-prefix { /* ... */ }
         .flight-number-input-group input[name^="flightNumber_S"] { /* Now targets per-sector inputs */ width: 70px; flex-grow: 0; flex-shrink: 0; padding: 10px 8px; margin-bottom: 0; box-sizing: border-box; }
         .flight-number-input-group .button-delete { /* ... */ }


        .briefing-section-adder { /* ... */ }
        body.night-mode .briefing-section-adder { /* ... */ }
        .briefing-section-adder label { /* ... */ }
        .briefing-section-adder select { /* ... */ }

        .dynamic-briefing-section { /* ... */ }
        body.night-mode .dynamic-briefing-section { /* ... */ }
        .dynamic-briefing-section h4 { /* ... */ }
        body.night-mode .dynamic-briefing-section h4 { /* ... */ }
        .dynamic-briefing-section .button-delete { /* ... */ }

        /* Dynamic Sector Tabs */
        .sector-tabs { margin-bottom: 15px; border-bottom: 1px solid var(--border-color-day); padding-bottom: 0; display: flex; align-items: center; flex-wrap: wrap; /* Allow wrapping */ }
        body.night-mode .sector-tabs { border-bottom-color: var(--border-color-night); }
        .sector-tab { background-color: var(--placeholder-bg-day); color: var(--text-color-day); border: 1px solid var(--border-color-day); border-bottom: none; padding: 8px 10px; cursor: pointer; display: inline-flex; /* Use flex for button+delete */ align-items: center; margin-right: 3px; margin-bottom: -1px; /* Overlap border */ border-radius: 4px 4px 0 0; opacity: 0.7; font-size: 0.9em;}
        body.night-mode .sector-tab { background-color: var(--placeholder-bg-night); border-color: var(--border-color-night); color: var(--text-color-night);}
        .sector-tab.active { opacity: 1; font-weight: bold; background-color: var(--section-bg-day); border-bottom: 1px solid var(--section-bg-day); /* Hide bottom border */ }
        body.night-mode .sector-tab.active { background-color: var(--section-bg-night); border-bottom-color: var(--section-bg-night); }
        .sector-tab .tab-remove-btn { background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; line-height: 16px; text-align: center; cursor: pointer; margin-left: 8px; padding: 0; }
        body.night-mode .sector-tab .tab-remove-btn { background: #d43f3f; }
        .add-sector-tab-btn { background: #5cb85c; color: white; border: none; border-radius: 4px; width: 25px; height: 25px; font-size: 16px; line-height: 25px; text-align: center; cursor: pointer; margin-left: 10px; padding: 0; font-weight: bold;}
        body.night-mode .add-sector-tab-btn { background: #4cae4c; }

        .sector-content { display: none; margin-top:10px; }
        .sector-content.active { display: block; }


        .editor-toolbar { /* ... */ }
        .editor-toolbar button { /* ... */ }
        body.night-mode .editor-toolbar button { /* ... */ }
        .editor-toolbar button:hover { /* ... */ }
        body.night-mode .editor-toolbar button:hover { /* ... */ }
        .editable-content { /* ... */ }
        body.night-mode .editable-content { /* ... */ }
        .editable-content:focus { /* ... */ }
        body.night-mode .editable-content:focus { /* ... */ }

        .switch { /* ... */ } /* Dark mode toggle */
        /* ... other styles ... */

        .data-list, .search-results-display-area, #station-briefs-full-list-container, #view-brief-details-container, #print-area { /* ... */ }
        body.night-mode .data-list, body.night-mode .search-results-display-area, body.night-mode #station-briefs-full-list-container, body.night-mode #view-brief-details-container, body.night-mode #print-area { /* ... */ }
        #station-briefs-full-list-container ul { /* ... */ }
        #station-briefs-full-list-container li { /* ... */ }
        #station-briefs-full-list-container li:hover { /* ... */ }
        body.night-mode #station-briefs-full-list-container li { /* ... */ }
        body.night-mode #station-briefs-full-list-container li:hover { /* ... */ }
        #station-briefs-full-list-container li:last-child { /* ... */ }

        #view-brief-details-container .brief-detail-section { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section { /* ... */ }
        #view-brief-details-container .brief-detail-section:last-child { /* ... */ }
        #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        #view-brief-details-container .brief-content { /* ... */ }
        body.night-mode #view-brief-details-container .brief-content { /* ... */ }
        #view-brief-details-container .sector-heading { font-weight: bold; margin-top: 15px; margin-bottom: 8px; display: block; font-size: 1.15em; color: var(--heading-color-day); border-bottom: 1px solid var(--border-color-day); padding-bottom: 5px;} /* Style for sector titles in view */
        body.night-mode #view-brief-details-container .sector-heading { color: var(--heading-color-night); border-bottom-color: var(--border-color-night);}

        /* Print Styles */
        @media print { /* ... styles as before ... */ }
        #print-view { display: none; }

    </style>
</head>
<body>

    <div class="header-controls"> <label class="switch" title="Toggle Day/Night Mode"> <input type="checkbox" id="darkModeToggle"> <span class="slider round"></span> </label> </div>

    <div class="container">
        <div id="menu-view" class="view active">
            <h2>Station Database</h2>
            <div class="menu-buttons"> <button class="button" onclick="showView('create-entry-view')">Create New Station Brief</button> <button class="button" onclick="showView('browse-station-briefs-view')">Browse Station Briefs</button> </div>
        </div>

        <div id="create-entry-view" class="view">
            <h2>Create New Station Brief</h2>
            <form id="station-entry-form">
                {/* --- Common Info --- */}
                <div class="top-row-layout">
                    <div class="form-section" id="aircraft-type-section"> <label for="aircraft-type">Aircraft Type</label> <select id="aircraft-type" name="aircraftType" required> <option value="" selected disabled>-- Select --</option> <option value="B737">B737</option> <option value="B787">B787</option> <option value="B777">B777</option> <option value="A350">A350</option> <option value="A380">A380</option> <option value="B747">B747</option> </select> </div>
                    <div class="form-section" id="station-icao-section"> <label for="station-icao">Station ICAO</label> <select id="station-icao" name="stationICAO"> <option value="" selected disabled>-- Select ICAO --</option> </select> </div>
                    <div class="form-section" id="station-iata-section"> <label for="station-iata">Station IATA</label> <select id="station-iata" name="stationIATA"> <option value="" selected disabled>-- Select IATA --</option> </select> </div>
                </div>
                <div id="add-station-manual-fields">
                     <p>Manually adding new station:</p> <div class="form-section"><label>New ICAO:</label><input type="text" name="stationICAONew" value=""></div> <div class="form-section"><label>New IATA:</label><input type="text" name="stationIATANew" value=""></div> <div class="form-section"><label>New Name:</label><input type="text" name="stationNameNew" value=""></div>
                </div>
                 {/* Flight numbers moved inside sector blocks */}
                <hr>

                 <h3>Sector Details</h3>
                 <div id="sector-tabs-container" class="sector-tabs">
                     {/* Tabs added dynamically by JS */}
                     <button type="button" class="add-sector-tab-btn" onclick="addSectorTab()" title="Add New Sector">+</button>
                 </div>

                 {/* Container for Sector Specific Inputs (Flight No, Sections) */}
                 <div id="sector-details-container">
                     {/* Content for each sector (including flight numbers and briefing sections) will be managed here by JS */}
                 </div>


                <div class="form-section" style="margin-top:30px;"> <button type="submit" class="button">Save Station Brief</button> <button type="button" class="button button-secondary" onclick="showView('menu-view')">Back to Menu</button> </div>
            </form>
        </div>

        <div id="browse-station-briefs-view" class="view">
             <h2>Browse Station Briefs</h2> <div class="form-section"> <label for="search-station-input">Search Station Briefs:</label> <input type="search" id="search-station-input" value=""> </div>
             <div id="view-brief-details-container" style="display:none;"></div> <h3>All Station Briefs</h3> <div id="station-briefs-full-list-container"> <p>Loading...</p> </div>
             <button type="button" class="button button-secondary" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="print-view"><h2>Station Brief</h2><div id="print-content"></div></div>

    </div>

    <script>
        // --- Configuration ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyV76pZNEbhDsVTiLl4y-oNkfYFFpL6oE88GhlkQv99vtYvg9kar_vvsnbhgWLEideu/exec'; // !!! PASTE YOUR URL HERE !!!

        // --- Global State ---
        let previousView = 'menu-view'; let sectorTabCounter = 0; let briefingSectionCounter = 0; let allFetchedBriefs = []; let currentlyViewedBrief = null;

        // --- Station Data ---
        const stationMasterList = [ /* ... list as before ... */ ];

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle'); function setDarkMode(isNight) { /* ... */ } if (darkModeToggle) { /* ... */ }

        // --- View Switching ---
        const viewBriefDetailsContainer = document.getElementById('view-brief-details-container'); const stationBriefsFullListContainer = document.getElementById('station-briefs-full-list-container'); const searchStationInputField = document.getElementById('search-station-input'); const browseViewH3 = document.querySelector('#browse-station-briefs-view h3');
        function showView(viewId) { /* ... logic as before ... */ }

        function resetCreateEntryForm() {
            const form = document.getElementById('station-entry-form'); if(form) form.reset();
            document.getElementById('sector-tabs-container').innerHTML = '<button type="button" class="add-sector-tab-btn" onclick="addSectorTab()" title="Add New Sector">+</button>'; // Clear tabs except add button
            document.getElementById('sector-details-container').innerHTML = ''; // Clear sector details
            sectorTabCounter = 0; briefingSectionCounter = 0;
            const manualFields = document.getElementById('add-station-manual-fields'); manualFields.style.display = 'none';
            document.getElementById('station-icao-new').required = false; /* ... clear manual fields ... */ document.getElementById('station-name-new').value = "";
            document.getElementById('aircraft-type').selectedIndex = 0; document.getElementById('station-icao').selectedIndex = 0; document.getElementById('station-iata').selectedIndex = 0;
            addSectorTab(); // Add the first sector tab automatically
        }

        // --- Station Dropdowns ---
        const stationICAOSelect = document.getElementById('station-icao'); /* ... other vars ... */ function populateStationDropdowns() { /* ... */ } function handleStationSelectChange(changedSelect, otherSelect) { /* ... */ }
        stationICAOSelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); }); stationIATASelect.addEventListener('change', function() { handleStationSelectChange(this, stationICAOSelect); });

        // --- Dynamic Sector Tab and Content Management ---
        const sectorTabsContainer = document.getElementById('sector-tabs-container');
        const sectorDetailsContainer = document.getElementById('sector-details-container');
        const addSectorTabButton = sectorTabsContainer.querySelector('.add-sector-tab-btn'); // Keep reference to the add button

         const predefinedSectionTitles = { /* ... */ };
         const sectionKeyMap = { /* ... */ };


        function addSectorTab(makeActive = true) {
            sectorTabCounter++;
            const sectorIndex = sectorTabCounter; // Use counter for unique index

            // 1. Create Tab Button
            const tabButton = document.createElement('button');
            tabButton.type = 'button';
            tabButton.classList.add('sector-tab');
            tabButton.textContent = `Sector ${sectorIndex}`;
            tabButton.dataset.sectorIndex = sectorIndex;
            tabButton.onclick = function() { switchSectorTab(this, sectorIndex); };

            // Add remove button only if it's not the first tab
            if (sectorIndex > 1) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('tab-remove-btn');
                removeBtn.textContent = 'x';
                removeBtn.title = `Remove Sector ${sectorIndex}`;
                removeBtn.onclick = function(event) {
                    event.stopPropagation(); // Prevent tab switch when clicking remove
                    removeSectorTab(sectorIndex);
                };
                tabButton.appendChild(removeBtn);
            }
            sectorTabsContainer.insertBefore(tabButton, addSectorTabButton); // Insert before the '+' button

            // 2. Create Sector Details Container
            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('sector-content'); // Initially hidden unless activated
            detailsDiv.id = `sector-details-${sectorIndex}`;
            detailsDiv.dataset.sectorIndex = sectorIndex; // Link content to tab index

             // Add Flight Numbers section for this sector
             const flightContainerId = `flight-numbers-container-S${sectorIndex}`;
             detailsDiv.innerHTML += `
                <div class="form-section" id="flight-numbers-section-${sectorIndex}">
                    <label>Flight Number(s) Applicable (Sector ${sectorIndex})</label>
                    <div id="${flightContainerId}">
                        <div class="flight-number-input-group">
                            <span class="sq-prefix">SQ</span>
                            <input type="text" name="flightNumber_S${sectorIndex}[]" value="">
                        </div>
                    </div>
                    <button type="button" class="button button-secondary add-flight-no-btn" onclick="addFlightNumberField('${flightContainerId}', ${sectorIndex})" style="font-size: 0.8em; padding: 3px 8px; margin-top: 5px;">+ Flight No.</button>
                </div>
                 <hr>
                 <h4>Briefing Sections (Sector ${sectorIndex})</h4>
                 <div id="active-briefing-sections-container-${sectorIndex}" class="active-briefing-sections-container-per-sector">
                     <div class="briefing-section-adder" id="section-adder-${sectorIndex}">
                        <label for="add-section-select-${sectorIndex}">Add briefing section:</label>
                        <select id="add-section-select-${sectorIndex}" onchange="addSelectedBriefingSection(this, ${sectorIndex})">
                            <option value="" disabled selected>-- Select to Add --</option>
                             ${Object.keys(predefinedSectionTitles).map(key => `<option value="${key}">${predefinedSectionTitles[key]}</option>`).join('')}
                            <option value="custom">Custom Section</option>
                        </select>
                    </div>
                 </div>
             `;
            sectorDetailsContainer.appendChild(detailsDiv);

             // 3. Add existing section types to this new sector's details container
             const existingSectionKeys = new Set();
             document.querySelectorAll('#sector-details-container .dynamic-briefing-section[data-section-key]').forEach(el => {
                 if(el.closest('.sector-content').dataset.sectorIndex === "1") { // Check sections in the first sector
                     existingSectionKeys.add(el.dataset.sectionKey);
                 }
             });
              existingSectionKeys.forEach(sectionValue => {
                  // Pass the original select element from the first sector to reuse its value? No, just the key.
                  addSelectedBriefingSection({ value: sectionValue }, sectorIndex, true); // Pass true to skip alert
              });
              // Add custom sections too
               const existingCustomTitles = [];
               document.querySelectorAll('#sector-details-1 .dynamic-briefing-section[id^="custom-section-"]').forEach(el => {
                    const titleInput = el.querySelector('input[name="customSectionTitle[]"]'); // Adjust name if needed based on structure
                    if (titleInput) existingCustomTitles.push(titleInput.value || `Custom Section ${el.id.split('-').pop()}`); // Get title
               });
                 existingCustomTitles.forEach(title => {
                     addSelectedBriefingSection({ value: 'custom' }, sectorIndex, true, title); // Pass title if needed
                 });


            // 4. Activate the new tab if requested
            if (makeActive) {
                switchSectorTab(tabButton, sectorIndex);
            } else {
                 detailsDiv.style.display = 'none'; // Ensure it's hidden
            }

             return sectorIndex; // Return index if needed
        }


        function removeSectorTab(sectorIndexToRemove) {
            if (sectorIndexToRemove <= 1) { alert("Cannot remove the first sector."); return; } // Prevent removing the first tab

            if (confirm(`Are you sure you want to remove Sector ${sectorIndexToRemove} and all its content?`)) {
                // Remove Tab Button
                const tabButton = sectorTabsContainer.querySelector(`.sector-tab[data-sector-index="${sectorIndexToRemove}"]`);
                if (tabButton) tabButton.remove();

                // Remove Details Container
                const detailsDiv = sectorDetailsContainer.querySelector(`#sector-details-${sectorIndexToRemove}`);
                if (detailsDiv) detailsDiv.remove();

                // Switch to the previous tab if the removed one was active
                if (!sectorTabsContainer.querySelector('.sector-tab.active')) {
                    const prevTabIndex = sectorIndexToRemove - 1;
                    const prevTabButton = sectorTabsContainer.querySelector(`.sector-tab[data-sector-index="${prevTabIndex}"]`);
                    if (prevTabButton) switchSectorTab(prevTabButton, prevTabIndex);
                    else { // Fallback if somehow the previous doesn't exist, go to first
                         const firstTabButton = sectorTabsContainer.querySelector('.sector-tab');
                         if(firstTabButton) switchSectorTab(firstTabButton, firstTabButton.dataset.sectorIndex);
                    }
                }
            }
        }

        function switchSectorTab(tabButtonToActivate, sectorIndexToActivate) {
            // Deactivate all tabs and content
            sectorTabsContainer.querySelectorAll('.sector-tab').forEach(tab => tab.classList.remove('active'));
            sectorDetailsContainer.querySelectorAll('.sector-content').forEach(content => content.classList.remove('active')); // Use class now

            // Activate the selected tab and content
            tabButtonToActivate.classList.add('active');
            const contentDiv = sectorDetailsContainer.querySelector(`#sector-details-${sectorIndexToActivate}`);
            if (contentDiv) contentDiv.classList.add('active');
        }


         function addFlightNumberField(containerId, sectorIndex) {
             const container = document.getElementById(containerId); if (!container) return;
             const newFieldGroup = document.createElement('div'); newFieldGroup.classList.add('flight-number-input-group');
             newFieldGroup.innerHTML = `<span class="sq-prefix">SQ</span><input type="text" name="flightNumber_S${sectorIndex}[]" value=""><button type="button" class="button-delete" onclick="this.parentElement.remove()">X</button>`;
             container.appendChild(newFieldGroup);
         }

        function addSelectedBriefingSection(selectElementOrValue, sectorIndex, suppressAlert = false, customTitleSeed = '') {
             const sectionValue = typeof selectElementOrValue === 'string' ? selectElementOrValue : selectElementOrValue.value;
             const isInitialAddForNewTab = typeof selectElementOrValue === 'string'; // Check if called during tab creation

             if (!sectionValue) return;
             const targetContainer = document.getElementById(`active-briefing-sections-container-${sectorIndex}`);
             const adderElement = document.getElementById(`section-adder-${sectorIndex}`);
             if (!targetContainer || !adderElement) { console.error("Target/adder missing S" + sectorIndex); return; }

             const sectionKey = sectionValue !== 'custom' ? sectionKeyMap[sectionValue] : null;

             if (!suppressAlert && sectionValue !== 'custom' && targetContainer.querySelector(`.dynamic-briefing-section[data-section-key="${sectionValue}"]`)) {
                 alert(`"${predefinedSectionTitles[sectionValue]}" already added for Sector ${sectorIndex}.`);
                 if (!isInitialAddForNewTab) selectElementOrValue.value = ""; return; // Only reset if user interaction
             }

             briefingSectionCounter++; // Use global counter for unique IDs across sectors
             const sectionIdBase = (sectionValue === 'custom') ? `custom-section-${briefingSectionCounter}` : `briefing-section-${sectionValue}-${briefingSectionCounter}`;
             const sectionContainer = document.createElement('div'); sectionContainer.classList.add('dynamic-briefing-section'); sectionContainer.id = sectionIdBase;
             if (sectionValue !== 'custom') sectionContainer.dataset.sectionKey = sectionValue;

             const isCustom = (sectionValue === 'custom');
             let sectionTitleText = isCustom ? (customTitleSeed || `Custom Section`) : predefinedSectionTitles[sectionValue];

             const editorId = `${sectionIdBase}-content`;
             const hiddenInputName = isCustom ? `customSectionContentValue_S${sectorIndex}[]` : `${sectionKey}ContentValue_S${sectorIndex}`;
             const hiddenInputId = `${sectionIdBase}-value`;
             const titleInputName = isCustom ? `customSectionTitle_S${sectorIndex}[]` : '';

             sectionContainer.innerHTML = `
                 <button type="button" class="button button-delete" onclick="removeBriefingSection('${sectionIdBase}')">Remove</button>
                 ${isCustom ? `<label>Section Title:</label><input type="text" name="${titleInputName}" value="${sectionTitleText}" placeholder="Enter Custom Title" style="margin-bottom:10px; font-weight:bold;">` : `<h4>${sectionTitleText}</h4>`}
                 <div class="editor-toolbar"> <button type="button" title="Bold" onclick="formatDoc('bold','${editorId}');"><b>B</b></button> <button type="button" title="Italic" onclick="formatDoc('italic','${editorId}');"><i>I</i></button> <button type="button" title="Underline" onclick="formatDoc('underline','${editorId}');"><u>U</u></button> <button type="button" title="Unordered List" onclick="formatDoc('insertUnorderedList','${editorId}');">&bull;&equiv;</button> </div>
                 <div id="${editorId}" class="editable-content" contenteditable="true"></div> <input type="hidden" name="${hiddenInputName}" id="${hiddenInputId}">`;

             targetContainer.insertBefore(sectionContainer, adderElement);
             if (!isInitialAddForNewTab) selectElementOrValue.value = ""; // Reset dropdown only if triggered by user change
         }


        function removeBriefingSection(sectionId) { /* ... as before ... */ }
        function formatDoc(command, editorId, valueArgument = null) { /* ... as before ... */ }

        // --- Form Submission (Dynamic Tabs - Sends Multiple POSTs) ---
        const stationEntryForm = document.getElementById('station-entry-form');
        if (stationEntryForm) {
            stationEntryForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitButton = stationEntryForm.querySelector('button[type="submit"]'); const btnTxt = submitButton.textContent;

                 // --- Common Data Validation ---
                 let isManual = stationICAOSelect.value === '__add_new__' || stationIATASelect.value === '__add_new__';
                 if (!stationEntryForm.elements['aircraftType'].value) { alert("Select Aircraft Type."); return; }
                 if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station or add manually."); return; }
                 if (isManual && (!stationEntryForm.elements['stationICAONew'].value || !stationEntryForm.elements['stationNameNew'].value)) { alert("Manual entry needs ICAO & Name."); return; }
                 if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station."); return; }
                 const sectorBlocks = sectorsContainer.querySelectorAll('.sector-block');
                 if (sectorBlocks.length === 0) { alert("Please add at least one sector brief."); return; }
                 // --- End Validation ---

                 submitButton.disabled = true; submitButton.textContent = 'Saving...';
                 let successfulSubmits = 0; let failedSubmits = 0;
                 const submissionPromises = [];

                  // Update all hidden inputs before looping
                  document.querySelectorAll('.editable-content').forEach(editor => { const hid = editor.id.replace('-content', '-value'); const hin = document.getElementById(hid); if (hin) hin.value = editor.innerHTML; });


                 // Loop through each sector block and create a submission promise for it
                 for (const sectorBlock of sectorBlocks) {
                     const sectorIndex = sectorBlock.dataset.sectorIndex;
                     const payload = {}; // Payload for this specific sector

                     const sectorIdentifierInput = sectorBlock.querySelector(`input[name="sectorIdentifier_${sectorIndex}"]`);
                     if (!sectorIdentifierInput || !sectorIdentifierInput.value) {
                         alert(`Please enter a Sector Identifier for Sector ${sectorIndex}. Skipping this sector.`);
                         failedSubmits++; // Count as failed if identifier is missing
                         continue; // Skip this sector block
                     }
                     payload.sectorIdentifier = sectorIdentifierInput.value; // Add sector ID

                      // Get common info (could be cached outside loop)
                     if (isManual) { payload.stationInfo = JSON.stringify({ icao: stationEntryForm.elements['stationICAONew'].value.toUpperCase(), iata: stationEntryForm.elements['stationIATANew'].value.toUpperCase() || '', name: stationEntryForm.elements['stationNameNew'].value }); }
                     else if (stationEntryForm.elements['stationICAO'].value) { const f = stationMasterList.find(s=>s.icao===stationEntryForm.elements['stationICAO'].value); payload.stationInfo = JSON.stringify(f ? {...f} : {icao: stationEntryForm.elements['stationICAO'].value, iata: stationEntryForm.elements['stationIATA'].value||'', name:'N/A'}); }
                     else if (stationEntryForm.elements['stationIATA'].value) { const f = stationMasterList.find(s=>s.iata===stationEntryForm.elements['stationIATA'].value); payload.stationInfo = JSON.stringify(f ? {...f} : {icao: '', iata: stationEntryForm.elements['stationIATA'].value, name:'N/A'}); }
                     payload.aircraftType = stationEntryForm.elements['aircraftType'].value;

                     // Collect flight numbers for this sector
                     const flightNumbers = []; sectorBlock.querySelectorAll(`input[name="flightNumber_S${sectorIndex}[]"]`).forEach(input => { if (input.value.trim()) flightNumbers.push(input.value.trim()); });
                     payload.flightNumbers = JSON.stringify(flightNumbers);

                     // Collect predefined sections for this sector
                     for (const key in sectionKeyMap) { const inputName = `${sectionKeyMap[key]}ContentValue_S${sectorIndex}`; const hiddenInput = sectorBlock.querySelector(`input[name="${inputName}"]`); payload[sectionKeyMap[key] + 'ContentValue'] = hiddenInput ? hiddenInput.value : ''; }

                      // Collect custom sections for this sector
                     let customSections = []; const customTitles = sectorBlock.querySelectorAll(`input[name="customSectionTitle_S${sectorIndex}[]"]`); const customContents = sectorBlock.querySelectorAll(`input[name="customSectionContentValue_S${sectorIndex}[]"]`);
                     customTitles.forEach((titleInput, index) => { customSections.push({ title: titleInput.value, content: customContents[index]?.value || '' }); });
                     payload.customSections = JSON.stringify(customSections);

                     console.log(`Payload S${sectorIndex}:`, payload);

                     // Add fetch promise (using simplified backend)
                     submissionPromises.push(
                         fetch(WEB_APP_URL, { method: 'POST', body: new URLSearchParams(payload), headers: {'Content-Type': 'application/x-www-form-urlencoded'} })
                         .then(res => res.json())
                         .then(res => { if (res.status === 'success') { successfulSubmits++; return true; } else { throw new Error(res.message || `Sector ${sectorIndex} failed`); } })
                         .catch(err => { failedSubmits++; console.error(`Error Sector ${sectorIndex}:`, err); return false; })
                     );
                 } // End loop

                 // Wait for all promises
                 await Promise.all(submissionPromises);

                 alert(`${successfulSubmits} sector brief(s) saved successfully. ${failedSubmits} failed.`);

                 if (successfulSubmits > 0) { // Only reset and navigate if at least one worked
                     allFetchedBriefs = []; // Clear cache
                     resetCreateEntryForm();
                     showView('browse-station-briefs-view');
                 } else { // Stay on page if all failed
                     submitButton.disabled = false; submitButton.textContent = btnTxt;
                 }

            }); // End form submit listener
        }

        // --- Browse Station Briefs Logic ---
        function displayBriefDetails(briefId) { /* ... Same as simplified version (shows one sector's details) ... */ }
        function hideBriefDetails() { /* ... Same as simplified version ... */ }
        async function loadAndDisplayAllBriefs(searchTerm = '') { /* ... Same as simplified version (shows SectorIdentifier) ... */ }
        if (searchStationInputField) { /* ... Same as simplified version ... */ }
        function printBriefDetails() { /* ... Same as simplified version ... */ }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedDarkMode = localStorage.getItem('darkModePrefStationDB'); setDarkMode(savedDarkMode === 'true');
            populateStationDropdowns();
            resetCreateEntryForm(); // Add the first sector block
            showView('menu-view');
        });
    </script>
</body>
</html>
