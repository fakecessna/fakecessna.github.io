<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Database - Alpha</title>
    <style>
        /* General Styles */
        :root { /* ... CSS Variables as before ... */ }
        html, body { /* ... */ }
        body.night-mode { /* ... */ }
        .header-controls { /* ... */ }
        .container { /* ... */ }
        body.night-mode .container { /* ... */ }
        .view { /* ... */ }
        .view.active { /* ... */ }
        @keyframes fadeIn { /* ... */ }
        h2, h3, h4 { /* ... */ }
        body.night-mode h2, body.night-mode h3, body.night-mode h4 { /* ... */ }
        .button { /* ... */ }
        .button:hover { /* ... */ }
        body.night-mode .button { /* ... */ }
        .button-secondary { /* ... */ }
        body.night-mode .button-secondary { /* ... */ }
        .button-delete { /* ... */ }
        body.night-mode .button-delete { /* ... */ }
        button:disabled { /* ... */ }
        body.night-mode button:disabled { /* ... */ }
        .menu-buttons button { /* ... */ }
        .form-section { margin-bottom: 20px; }
        .form-section label { /* ... */ }
        body.night-mode .form-section label { /* ... */ }
        .form-section input[type="text"], .form-section input[type="search"], .form-section select, .form-section textarea { /* ... */ }
        body.night-mode .form-section input[type="text"], body.night-mode .form-section input[type="search"], body.night-mode .form-section select, body.night-mode .form-section textarea { /* ... */ }
        .form-section input[type="text"]:focus, .form-section input[type="search"]:focus, .form-section select:focus, .form-section textarea:focus { /* ... */ }
        body.night-mode .form-section input[type="text"]:focus, body.night-mode .form-section input[type="search"]:focus, body.night-mode .form-section select:focus, body.night-mode .form-section textarea:focus { /* ... */ }

        .top-row-layout { /* ... */ }
        .top-row-layout .form-section { /* ... */ }
        .top-row-layout #aircraft-type-section { /* ... */ }
        .top-row-layout #station-icao-section, .top-row-layout #station-iata-section { /* ... */ }

        #add-station-manual-fields { /* ... */ }
        body.night-mode #add-station-manual-fields { /* ... */ }
        #add-station-manual-fields .form-section { /* ... */ }
         @media (max-width: 768px) { /* ... */ }

        /* Sector Block Styling */
        .sector-block {
            border: 2px dashed var(--input-border-day);
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            position: relative; /* For delete button */
        }
        body.night-mode .sector-block { border-color: var(--input-border-night); }
        .sector-block h3 { border: none; margin-bottom: 15px; padding-bottom: 0; font-size: 1.2em; }
         .sector-block .button-delete-sector { /* Specific delete button for sector */
            position: absolute; top: 10px; right: 10px;
            background-color: #bb2d3b; /* Darker red */
         }
         body.night-mode .sector-block .button-delete-sector { background-color: #a52834; }


        #flight-numbers-section-per-sector { margin-bottom: 20px; } /* Renamed ID just in case */
        .flight-number-input-group { /* ... */ }
        .flight-number-input-group span.sq-prefix { /* ... */ }
        body.night-mode .flight-number-input-group span.sq-prefix { /* ... */ }
        .flight-number-input-group input[name^="flightNumber_S"] { /* Targeting flight numbers within sectors */ width: 70px; flex-grow: 0; flex-shrink: 0; padding: 10px 8px; margin-bottom: 0; box-sizing: border-box; }
        .flight-number-input-group .button-delete { /* ... */ }

        .briefing-section-adder { /* ... */ }
        body.night-mode .briefing-section-adder { /* ... */ }
        .briefing-section-adder label { /* ... */ }
        .briefing-section-adder select { /* ... */ }

        .dynamic-briefing-section { /* ... */ }
        body.night-mode .dynamic-briefing-section { /* ... */ }
        .dynamic-briefing-section h4 { /* ... */ }
        body.night-mode .dynamic-briefing-section h4 { /* ... */ }
        .dynamic-briefing-section .button-delete { /* ... */ }

        .editor-toolbar { /* ... */ }
        .editor-toolbar button { /* ... */ }
        body.night-mode .editor-toolbar button { /* ... */ }
        .editor-toolbar button:hover { /* ... */ }
        body.night-mode .editor-toolbar button:hover { /* ... */ }
        .editable-content { /* ... */ }
        body.night-mode .editable-content { /* ... */ }
        .editable-content:focus { /* ... */ }
        body.night-mode .editable-content:focus { /* ... */ }

        .switch { /* ... */ } /* Dark mode toggle */
        /* ... other styles ... */

        .data-list, .search-results-display-area, #station-briefs-full-list-container, #view-brief-details-container, #print-area { /* ... */ }
        body.night-mode .data-list, body.night-mode .search-results-display-area, body.night-mode #station-briefs-full-list-container, body.night-mode #view-brief-details-container, body.night-mode #print-area { /* ... */ }
        #station-briefs-full-list-container ul { /* ... */ }
        #station-briefs-full-list-container li { /* ... */ }
        #station-briefs-full-list-container li:hover { /* ... */ }
        body.night-mode #station-briefs-full-list-container li { /* ... */ }
        body.night-mode #station-briefs-full-list-container li:hover { /* ... */ }
        #station-briefs-full-list-container li:last-child { /* ... */ }

        #view-brief-details-container .brief-detail-section { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section { /* ... */ }
        #view-brief-details-container .brief-detail-section:last-child { /* ... */ }
        #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        body.night-mode #view-brief-details-container .brief-detail-section h5 { /* ... */ }
        #view-brief-details-container .brief-content { /* ... */ }
        body.night-mode #view-brief-details-container .brief-content { /* ... */ }
        #view-brief-details-container .sector-heading { /* ... Removed as view is per-sector */ }
        body.night-mode #view-brief-details-container .sector-heading { /* ... Removed ... */ }

        /* Print Styles */
        @media print { /* ... as before ... */ }
        #print-view { display: none; }

    </style>
</head>
<body>

    <div class="header-controls"> <label class="switch" title="Toggle Day/Night Mode"> <input type="checkbox" id="darkModeToggle"> <span class="slider round"></span> </label> </div>

    <div class="container">
        <div id="menu-view" class="view active">
            <h2>Station Database</h2>
            <div class="menu-buttons"> <button class="button" onclick="showView('create-entry-view')">Create New Station Brief(s)</button> <button class="button" onclick="showView('browse-station-briefs-view')">Browse Station Briefs</button> </div>
        </div>

        <div id="create-entry-view" class="view">
            <h2>Create New Station Brief(s)</h2>
            <form id="station-entry-form">
                {/* --- Common Info --- */}
                <div class="top-row-layout">
                    <div class="form-section" id="aircraft-type-section"> <label for="aircraft-type">Aircraft Type</label> <select id="aircraft-type" name="aircraftType" required> <option value="" selected disabled>-- Select --</option> <option value="B737">B737</option> <option value="B787">B787</option> <option value="B777">B777</option> <option value="A350">A350</option> <option value="A380">A380</option> <option value="B747">B747</option> </select> </div>
                    <div class="form-section" id="station-icao-section"> <label for="station-icao">Station ICAO</label> <select id="station-icao" name="stationICAO"> <option value="" selected disabled>-- Select ICAO --</option> </select> </div>
                    <div class="form-section" id="station-iata-section"> <label for="station-iata">Station IATA</label> <select id="station-iata" name="stationIATA"> <option value="" selected disabled>-- Select IATA --</option> </select> </div>
                </div>
                <div id="add-station-manual-fields">
                    <p>Manually adding new station:</p>
                    <div class="form-section"><label>New ICAO:</label><input type="text" name="stationICAONew" value=""></div>
                    <div class="form-section"><label>New IATA:</label><input type="text" name="stationIATANew" value=""></div>
                    <div class="form-section"><label>New Name:</label><input type="text" name="stationNameNew" value=""></div>
                </div>
                <hr>

                {/* --- Container for Dynamic Sector Blocks --- */}
                <div id="sectors-container">
                    {/* Sector blocks will be added here by JS */}
                </div>

                {/* --- Add Sector Button --- */}
                <div class="form-section">
                    <button type="button" class="button button-secondary" onclick="addSectorBlock()">+ Add Sector Brief</button>
                </div>
                <hr>

                {/* --- Final Save/Back Buttons --- */}
                <div class="form-section" style="margin-top:30px;"> <button type="submit" class="button">Save All Added Briefs</button> <button type="button" class="button button-secondary" onclick="showView('menu-view')">Back to Menu</button> </div>
            </form>
        </div>

        <div id="browse-station-briefs-view" class="view">
             <h2>Browse Station Briefs</h2> <div class="form-section"> <label for="search-station-input">Search Station Briefs:</label> <input type="search" id="search-station-input" value=""> </div>
             <div id="view-brief-details-container" style="display:none;"></div> <h3>All Station Briefs</h3> <div id="station-briefs-full-list-container"> <p>Loading...</p> </div>
             <button type="button" class="button button-secondary" onclick="showView('menu-view')" style="margin-top: 15px;">Back to Menu</button>
        </div>

        <div id="print-view"><h2>Station Brief</h2><div id="print-content"></div></div>

    </div>

    <script>
        // --- Configuration ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyV76pZNEbhDsVTiLl4y-oNkfYFFpL6oE88GhlkQv99vtYvg9kar_vvsnbhgWLEideu/exec'; // !!! PASTE YOUR URL HERE !!!

        // --- Global State ---
        let previousView = 'menu-view'; let sectorBlockCounter = 0; let allFetchedBriefs = []; let currentlyViewedBrief = null;

        // --- Station Data (For Dropdowns) ---
        const stationMasterList = [ /* ... same list as before ... */ ];

        // --- Night Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle'); function setDarkMode(isNight) { /* ... */ } if (darkModeToggle) { /* ... */ }

        // --- View Switching & Control ---
        const viewBriefDetailsContainer = document.getElementById('view-brief-details-container'); const stationBriefsFullListContainer = document.getElementById('station-briefs-full-list-container'); const searchStationInputField = document.getElementById('search-station-input'); const browseViewH3 = document.querySelector('#browse-station-briefs-view h3');
        function showView(viewId) { /* ... same as before ... */ }

        function resetCreateEntryForm() {
            const form = document.getElementById('station-entry-form'); if(form) form.reset();
             // Clear dynamically added sector blocks
            document.getElementById('sectors-container').innerHTML = ''; sectorBlockCounter = 0;
            const manualFields = document.getElementById('add-station-manual-fields'); manualFields.style.display = 'none';
            document.getElementById('station-icao-new').required = false; document.getElementById('station-iata-new').required = false; document.getElementById('station-name-new').required = false;
            document.getElementById('station-icao-new').value = ""; document.getElementById('station-iata-new').value = ""; document.getElementById('station-name-new').value = "";
            document.getElementById('aircraft-type').selectedIndex = 0; document.getElementById('station-icao').selectedIndex = 0; document.getElementById('station-iata').selectedIndex = 0;
            addSectorBlock(); // Add one initial sector block on reset/load
        }

        // --- Populate Station Dropdowns & Handle Linking ---
        const stationICAOSelect = document.getElementById('station-icao'); const stationIATASelect = document.getElementById('station-iata'); const manualStationFieldsDiv = document.getElementById('add-station-manual-fields'); const stationICAONewInput = document.getElementById('station-icao-new'); const stationIATANewInput = document.getElementById('station-iata-new'); const stationNameNewInput = document.getElementById('station-name-new');
        function populateStationDropdowns() { /* ... same sorting logic as before ... */ }
        function handleStationSelectChange(changedSelect, otherSelect) { /* ... same logic as before ... */ }
        stationICAOSelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); });
        stationIATASelect.addEventListener('change', function() { handleStationSelectChange(this, stationIATASelect); });

        // --- Sector Block Management ---
        const sectorsContainer = document.getElementById('sectors-container');
        const predefinedSectionTitles = { station_overview: "Station Overview", operational_policy: "Operational Policy", preflight: "Preflight", pushback_taxi: "Pushback & Taxi", climb_enroute: "Climb & Enroute", arrival: "Arrival", taxi_in_parking: "Taxi-In and Parking", tem: "Threat and Error Management (TEM)", night_stop_info: "Night Stop Information", things_to_do: "Things To Do" };
        const sectionKeyMap = { station_overview: "StationOverview", operational_policy: "OperationalPolicy", preflight: "Preflight", pushback_taxi: "PushbackTaxi", climb_enroute: "ClimbEnroute", arrival: "Arrival", taxi_in_parking: "TaxiInParking", tem: "TEM", night_stop_info: "NightStopInfo", things_to_do: "ThingsToDo" };
        let briefingSectionCounter = 0; // Counter for unique section IDs across all sectors

        function addSectorBlock() {
            sectorBlockCounter++;
            const sectorDiv = document.createElement('div');
            sectorDiv.classList.add('sector-block');
            sectorDiv.id = `sector-block-${sectorBlockCounter}`;
            sectorDiv.dataset.sectorIndex = sectorBlockCounter; // Store index

            // Generate unique IDs for elements within this sector
            const sectorIdInputId = `sector-identifier-${sectorBlockCounter}`;
            const flightContainerId = `flight-numbers-container-${sectorBlockCounter}`;
            const sectionsContainerId = `active-briefing-sections-container-${sectorBlockCounter}`;
            const sectionAdderId = `section-adder-${sectorBlockCounter}`;
            const sectionSelectId = `add-section-select-${sectorBlockCounter}`;

            sectorDiv.innerHTML = `
                <button type="button" class="button button-delete button-delete-sector" onclick="this.parentElement.remove()">Remove Sector ${sectorBlockCounter}</button>
                <h3>Sector ${sectorBlockCounter} Details</h3>

                <div class="form-section">
                    <label for="${sectorIdInputId}">Sector Identifier / Description</label>
                    <input type="text" id="${sectorIdInputId}" name="sectorIdentifier_${sectorBlockCounter}" required value="" placeholder="e.g., Outbound, SQ123">
                </div>

                <div class="form-section" id="flight-numbers-section-per-sector">
                    <label>Flight Number(s) Applicable (for Sector ${sectorBlockCounter})</label>
                    <div id="${flightContainerId}">
                        <div class="flight-number-input-group">
                            <span class="sq-prefix">SQ</span>
                            <input type="text" name="flightNumber_S${sectorBlockCounter}[]" value="">
                        </div>
                    </div>
                    <button type="button" class="button button-secondary add-flight-no-btn" onclick="addFlightNumberField('${flightContainerId}', ${sectorBlockCounter})" style="font-size: 0.8em; padding: 3px 8px; margin-top: 5px;">+ Flight No.</button>
                </div>

                <h4>Briefing Sections (for Sector ${sectorBlockCounter})</h4>
                <div id="${sectionsContainerId}" class="active-briefing-sections-container-per-sector">
                     <div class="briefing-section-adder" id="${sectionAdderId}">
                        <label for="${sectionSelectId}">Add briefing section:</label>
                        <select id="${sectionSelectId}" onchange="addSelectedBriefingSection(this, ${sectorBlockCounter})">
                            <option value="" disabled selected>-- Select to Add --</option>
                            <option value="station_overview">Station Overview</option>
                            <option value="operational_policy">Operational Policy</option>
                            <option value="preflight">Preflight</option>
                            <option value="pushback_taxi">Pushback & Taxi</option>
                            <option value="climb_enroute">Climb & Enroute</option>
                            <option value="arrival">Arrival</option>
                            <option value="taxi_in_parking">Taxi-In and Parking</option>
                            <option value="tem">TEM</option>
                            <option value="night_stop_info">Night Stop Information</option>
                            <option value="things_to_do">Things To Do</option>
                            <option value="custom">Custom Section</option>
                        </select>
                    </div>
                </div>
            `;
            sectorsContainer.appendChild(sectorDiv);
        }

         function addFlightNumberField(containerId, sectorIndex) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const newFieldGroup = document.createElement('div');
            newFieldGroup.classList.add('flight-number-input-group');
            // Make sure name includes sector index
            newFieldGroup.innerHTML = `
                <span class="sq-prefix">SQ</span>
                <input type="text" name="flightNumber_S${sectorIndex}[]" value="">
                <button type="button" class="button-delete" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(newFieldGroup);
        }

        function addSelectedBriefingSection(selectElement, sectorIndex) {
            const sectionValue = selectElement.value;
            if (!sectionValue) return;
            const targetContainer = document.getElementById(`active-briefing-sections-container-${sectorIndex}`);
            const adderElement = document.getElementById(`section-adder-${sectorIndex}`); // Adder within this sector block

            if (!targetContainer || !adderElement) { console.error("Target container or adder not found for sector " + sectorIndex); return; }

            const sectionKey = sectionValue !== 'custom' ? sectionKeyMap[sectionValue] : null;

            // Check if section already exists WITHIN THIS SECTOR BLOCK
            if (sectionValue !== 'custom' && targetContainer.querySelector(`.dynamic-briefing-section[data-section-key="${sectionValue}"]`)) {
                alert(`"${predefinedSectionTitles[sectionValue]}" section already added for Sector ${sectorIndex}.`);
                selectElement.value = ""; return;
            }

            briefingSectionCounter++; // Global counter for unique element IDs
            const sectionIdBase = (sectionValue === 'custom') ? `custom-section-${briefingSectionCounter}` : `briefing-section-${sectionValue}-${briefingSectionCounter}`; // Make unique
            const sectionContainer = document.createElement('div'); sectionContainer.classList.add('dynamic-briefing-section'); sectionContainer.id = sectionIdBase;
            if (sectionValue !== 'custom') sectionContainer.dataset.sectionKey = sectionValue; // Store original key

            let sectionTitleText = (sectionValue === 'custom') ? `Custom Section` : predefinedSectionTitles[sectionValue]; // Custom title is now editable
            const isCustom = (sectionValue === 'custom');

            const editorId = `${sectionIdBase}-content`;
            // IMPORTANT: Names must include sector index for formData collection
            const hiddenInputName = isCustom ? `customSectionContentValue_S${sectorIndex}[]` : `${sectionKey}ContentValue_S${sectorIndex}`;
            const hiddenInputId = `${sectionIdBase}-value`;
            const titleInputName = isCustom ? `customSectionTitle_S${sectorIndex}[]` : '';

             sectionContainer.innerHTML = `
                <button type="button" class="button button-delete" onclick="removeBriefingSection('${sectionIdBase}')">Remove</button>
                ${isCustom ? `<label for="title-${sectionIdBase}">Section Title:</label><input type="text" id="title-${sectionIdBase}" name="${titleInputName}" value="" style="margin-bottom:10px; font-weight:bold;" placeholder="Enter Custom Title">` : `<h4>${sectionTitleText}</h4>`}
                <div class="editor-toolbar"> <button type="button" title="Bold" onclick="formatDoc('bold','${editorId}');"><b>B</b></button> <button type="button" title="Italic" onclick="formatDoc('italic','${editorId}');"><i>I</i></button> <button type="button" title="Underline" onclick="formatDoc('underline','${editorId}');"><u>U</u></button> <button type="button" title="Unordered List" onclick="formatDoc('insertUnorderedList','${editorId}');">&bull;&equiv;</button> </div>
                <div id="${editorId}" class="editable-content" contenteditable="true"></div>
                <input type="hidden" name="${hiddenInputName}" id="${hiddenInputId}">`;

            targetContainer.insertBefore(sectionContainer, adderElement); // Insert section before its adder
            selectElement.value = ""; // Reset this specific dropdown
        }

        function removeBriefingSection(sectionId) { /* ... same as before ... */ }
        function formatDoc(command, editorId, valueArgument = null) { /* ... same as before ... */ }

        // --- Form Submission (Multiple Sectors) ---
        const stationEntryForm = document.getElementById('station-entry-form');
        if (stationEntryForm) {
            stationEntryForm.addEventListener('submit', async function(event) { // Make async
                event.preventDefault();
                const submitButton = stationEntryForm.querySelector('button[type="submit"]'); const btnTxt = submitButton.textContent;

                 // --- Common Data Validation ---
                 let isManual = stationICAOSelect.value === '__add_new__' || stationIATASelect.value === '__add_new__';
                 if (!stationEntryForm.elements['aircraftType'].value) { alert("Select Aircraft Type."); return; }
                 if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station or add manually."); return; }
                 if (isManual && (!stationEntryForm.elements['stationICAONew'].value || !stationEntryForm.elements['stationNameNew'].value)) { alert("Manual entry needs ICAO & Name."); return; }
                 if (!isManual && !stationEntryForm.elements['stationICAO'].value && !stationEntryForm.elements['stationIATA'].value) { alert("Select station."); return; }
                 // --- End Common Validation ---

                 const sectorBlocks = sectorsContainer.querySelectorAll('.sector-block');
                 if (sectorBlocks.length === 0) { alert("Please add at least one sector brief using the '+ Add Sector Brief' button."); return; }

                 submitButton.disabled = true; submitButton.textContent = 'Saving...';
                 let allSubmissionsSuccessful = true;
                 const submissionPromises = [];

                 // Collect common station info once
                 let stationInfoPayload;
                 if (isManual) { stationInfoPayload = JSON.stringify({ icao: stationEntryForm.elements['stationICAONew'].value.toUpperCase(), iata: stationEntryForm.elements['stationIATANew'].value.toUpperCase() || '', name: stationEntryForm.elements['stationNameNew'].value }); }
                 else if (stationEntryForm.elements['stationICAO'].value) { const f = stationMasterList.find(s=>s.icao===stationEntryForm.elements['stationICAO'].value); stationInfoPayload = JSON.stringify(f ? {...f} : {icao: stationEntryForm.elements['stationICAO'].value, iata: stationEntryForm.elements['stationIATA'].value||'', name:'N/A'}); }
                 else if (stationEntryForm.elements['stationIATA'].value) { const f = stationMasterList.find(s=>s.iata===stationEntryForm.elements['stationIATA'].value); stationInfoPayload = JSON.stringify(f ? {...f} : {icao: '', iata: stationEntryForm.elements['stationIATA'].value, name:'N/A'}); }
                 const aircraftTypePayload = stationEntryForm.elements['aircraftType'].value;


                 // Iterate through each sector block
                 for (const sectorBlock of sectorBlocks) {
                     const sectorIndex = sectorBlock.dataset.sectorIndex;
                     const payload = {}; // Payload for this specific sector

                      // Update hidden inputs within this block *only*
                     sectorBlock.querySelectorAll('.editable-content').forEach(editor => { const hid = editor.id.replace('-content', '-value'); const hin = document.getElementById(hid); if (hin) hin.value = editor.innerHTML; });

                      const sectorIdentifierInput = sectorBlock.querySelector(`input[name="sectorIdentifier_${sectorIndex}"]`);
                      if (!sectorIdentifierInput || !sectorIdentifierInput.value) {
                          alert(`Please enter a Sector Identifier for Sector ${sectorIndex}.`);
                          sectorIdentifierInput?.focus();
                          allSubmissionsSuccessful = false;
                          break; // Stop processing further sectors if one is invalid
                      }

                      payload.stationInfo = stationInfoPayload;
                      payload.aircraftType = aircraftTypePayload;
                      payload.sectorIdentifier = sectorIdentifierInput.value;

                      // Collect flight numbers for this sector
                      const flightNumbers = [];
                      sectorBlock.querySelectorAll(`input[name="flightNumber_S${sectorIndex}[]"]`).forEach(input => { if (input.value.trim()) flightNumbers.push(input.value.trim()); });
                      payload.flightNumbers = JSON.stringify(flightNumbers);

                      // Collect predefined sections for this sector
                      for (const key in sectionKeyMap) {
                         const inputName = `${sectionKeyMap[key]}ContentValue_S${sectorIndex}`; // Correct name format
                         const hiddenInput = sectorBlock.querySelector(`input[name="${inputName}"]`);
                         payload[sectionKeyMap[key] + 'ContentValue'] = hiddenInput ? hiddenInput.value : ''; // Map to simple key for backend
                      }

                      // Collect custom sections for this sector
                      let customSections = [];
                      const customTitles = sectorBlock.querySelectorAll(`input[name="customSectionTitle_S${sectorIndex}[]"]`); // Use unique names if needed, or rely on structure - using structure here
                      const customContents = sectorBlock.querySelectorAll(`input[name="customSectionContentValue_S${sectorIndex}[]"]`);
                      customTitles.forEach((titleInput, index) => {
                          customSections.push({ title: titleInput.value, content: customContents[index]?.value || '' });
                      });
                      payload.customSections = JSON.stringify(customSections);

                      console.log(`Submitting Payload for Sector ${sectorIndex}:`, payload);

                      // Add the fetch promise to the array
                      submissionPromises.push(
                          fetch(WEB_APP_URL, {
                              method: 'POST',
                              body: new URLSearchParams(payload),
                              headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                          }).then(response => response.json())
                            .then(result => {
                                if (result.status !== 'success') {
                                    allSubmissionsSuccessful = false; // Mark failure if any sector fails
                                    console.error(`Error saving Sector ${sectorIndex}:`, result.message);
                                    alert(`Error saving Sector ${sectorIndex}: ${result.message}`);
                                } else {
                                    console.log(`Sector ${sectorIndex} saved successfully. ID: ${result.briefId}`);
                                }
                                return result; // Return result for Promise.all
                            }).catch(error => {
                                allSubmissionsSuccessful = false;
                                console.error(`Workspace Error for Sector ${sectorIndex}:`, error);
                                alert(`Network or script error saving Sector ${sectorIndex}: ${error.message}`);
                                return { status: "error", message: error.message }; // Return error status
                            })
                      ); // End push fetch promise

                      if (!allSubmissionsSuccessful) break; // Stop if validation failed earlier

                 } // End loop through sector blocks

                 // Wait for all submissions to complete
                 if(allSubmissionsSuccessful && submissionPromises.length > 0) {
                     try {
                         await Promise.all(submissionPromises); // Wait for all fetch calls
                         if (allSubmissionsSuccessful) { // Check again after promises resolve
                             alert(`All ${submissionPromises.length} sector brief(s) saved successfully!`);
                             allFetchedBriefs = []; // Clear cache
                             resetCreateEntryForm();
                             showView('browse-station-briefs-view');
                         } else {
                             alert("Some sectors failed to save. Please check the console for details and try again.");
                         }
                     } catch (error) {
                         // This catch might not be necessary if individual fetches handle errors
                         console.error("Error processing submissions:", error);
                         alert("An error occurred while processing submissions.");
                     }
                 }

                 // Re-enable button regardless of outcome if we didn't navigate away
                 submitButton.disabled = false; submitButton.textContent = btnTxt;

            }); // End form submit listener
        }

        // --- Browse Station Briefs Logic ---
        // displayBriefDetails, hideBriefDetails, loadAndDisplayAllBriefs, printBriefDetails
        // remain mostly the same as the *previous* version (single-sector display logic)
        // because each row fetched now represents a single sector.
        // Make sure loadAndDisplayAllBriefs shows the 'SectorIdentifier' in the list item.
        async function loadAndDisplayAllBriefs(searchTerm = '') {
             stationBriefsFullListContainer.innerHTML = '<p>Loading...</p>'; searchResultsDisplayArea.style.display = 'none';
             if (!WEB_APP_URL || WEB_APP_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE') { stationBriefsFullListContainer.innerHTML = '<p style="color:red;">Error: URL not set.</p>'; return; }
             try {
                 const response = await fetch(`${WEB_APP_URL}?action=getAllBriefs`); if (!response.ok) throw new Error(`HTTP ${response.status}`);
                 const result = await response.json(); if (result.status !== 'success') throw new Error(result.message);
                 allFetchedBriefs = result.data.map(b => ({ ...b, stationInfo: typeof b.stationInfo === 'string' ? JSON.parse(b.stationInfo || '{}') : b.stationInfo || {}, FlightNumbers: Array.isArray(b.FlightNumbers) ? b.FlightNumbers : [], CustomSections: Array.isArray(b.CustomSections) ? b.CustomSections : [] }));
             } catch (error) { console.error("Fetch Error:", error); stationBriefsFullListContainer.innerHTML = `<p>Error: ${error.message}.</p>`; return; }
             let briefsToDisplay = [...allFetchedBriefs];
             if (searchTerm) { const lSearch = searchTerm.toLowerCase(); briefsToDisplay = briefsToDisplay.filter(b => (b.stationInfo.icao?.toLowerCase().includes(lSearch)) || (b.stationInfo.iata?.toLowerCase().includes(lSearch)) || (b.stationInfo.name?.toLowerCase().includes(lSearch)) || (b.AircraftType?.toLowerCase().includes(lSearch)) || (b.SectorIdentifier?.toLowerCase().includes(lSearch)) || (b.FlightNumbers?.some(fn => fn.toLowerCase().includes(lSearch))) ); }
             if (briefsToDisplay.length === 0) { stationBriefsFullListContainer.innerHTML = `<p>No briefs found${searchTerm ? ' matching' : ''}.</p>`; return; }
             let listHtml = '<ul>'; briefsToDisplay.sort((a,b)=>(a.stationInfo.icao||"").localeCompare(b.stationInfo.icao||"")).forEach(b=>{const i=b.stationInfo?.icao||'N/A';const n=b.stationInfo?.name||'N/A';const a=b.AircraftType||'N/A';const u=b.LastUpdated||'N/A';const f=b.FlightNumbers?.length>0?`(SQ ${b.FlightNumbers.join('/')})`:'';const s=b.SectorIdentifier||'General';const id=b.rowId||b.BriefID;if(id){listHtml+=`<li onclick="displayBriefDetails('${id}')"><strong>${i} (${n})</strong> [${s}] - ${a}${f} - <em>Updated: ${u}</em></li>`;}else{listHtml+=`<li><strong>${i} (${n})</strong> [${s}] - ${a}${f} - <em>Updated: ${u}</em> (No ID)</li>`;}}); listHtml += '</ul>'; stationBriefsFullListContainer.innerHTML = listHtml;
        }
        function displayBriefDetails(briefId) { /* ... same as before (simplified view) ... */ }
        function hideBriefDetails() { /* ... same as before ... */ }
        function printBriefDetails() { /* ... same as before (simplified view) ... */ }
        if (searchStationInputField) { /* ... event listener as before ... */ }


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedDarkMode = localStorage.getItem('darkModePrefStationDB'); setDarkMode(savedDarkMode === 'true');
            populateStationDropdowns();
            // Don't initially place the adder, add the first sector block instead
            // if (sectionAdderElement) activeSectionsContainer.appendChild(sectionAdderElement);
             resetCreateEntryForm(); // Includes adding the first sector block
            showView('menu-view');
        });
    </script>
</body>
</html>
